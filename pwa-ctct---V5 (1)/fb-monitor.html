<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PTKV3 • FB Monitor (Chỉ huy)</title>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --ptk-red:#A41919; --ptk-gold:#FFD966; --ink:#0f172a; --bg:#FFF8ED; --muted:#6b7280; --border:#e5e7eb; --radius:16px; --shadow:0 12px 28px rgba(0,0,0,.08) }
    *{box-sizing:border-box}
    html,body{margin:0;min-height:100%;background:var(--bg);color:var(--ink)}
    body{font-family:"Be Vietnam Pro",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .topbar{position:sticky;top:0;z-index:30;color:#fff;background:linear-gradient(90deg,#7f1d1d 0%, #b91c1c 45%, #dc2626 100%)}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--ptk-gold);box-shadow:0 0 0 3px rgba(255,217,102,.3)}
    .container{max-width:1200px;margin:18px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .fld label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input[type="date"],select,input[type="text"]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;font:inherit}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer;font-size:13px}
    .chip.active{background:var(--ptk-gold);border-color:#c2a93f}
    .btn{border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--ptk-red);color:#fff;border-color:#7F1212}
    .stat{grid-column:span 3;min-height:86px}
    .stat .k{font-size:22px;font-weight:800}
    .stat .t{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:8px 10px}
    td{background:#fff;border:1px solid var(--border);padding:10px 10px}
    .link{font-size:13px;color:#2563eb;text-decoration:none}
    .banner{margin:12px 0}
    .banner .warn{background:#fff7ed;border:1px solid #f59e0b;color:#92400e;padding:10px;border-radius:8px}
    .banner .info{background:#eef2ff;border:1px solid #6366f1;color:#3730a3;padding:10px;border-radius:8px}
    .banner .err{background:#fee2e2;border:1px solid #ef4444;color:#991b1b;padding:10px;border-radius:8px;margin-top:8px}
    @media(max-width:960px){ .stat{grid-column:span 6} }
    @media(max-width:640px){ .stat{grid-column:span 12} }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap" style="display:flex;align-items:center;gap:12px">
      <div class="brand"><span class="dot"></span><span>PTKV3 • Giám sát Facebook</span></div>
      <div style="margin-left:auto;font-size:12px;opacity:.85">Realtime Webhook + Pull dự phòng</div>
    </div>
  </div>

  <main class="container">
    <div id="banner" class="banner"></div>

    <!-- Filters -->
    <section class="card">
      <div class="grid">
        <div class="fld" style="grid-column:span 4">
          <label>Từ ngày</label>
          <input type="date" id="fromDate" />
        </div>
        <div class="fld" style="grid-column:span 4">
          <label>Đến ngày</label>
          <input type="date" id="toDate" />
        </div>
        <div class="fld" style="grid-column:span 4">
          <label>Chọn Page</label>
          <select id="pageSelect"><option value="">Tất cả</option></select>
        </div>
        <div class="fld" style="grid-column:span 6">
          <label>Tìm kiếm (tên, nội dung bình luận, postId…)</label>
          <input type="text" id="keyword" placeholder="Nhập từ khóa…" />
        </div>
        <div class="fld" style="grid-column:span 6">
          <label>Loại tương tác</label>
          <div class="chips" id="types">
            <div class="chip active" data-type="comment">Comment</div>
            <div class="chip active" data-type="reaction">Reaction</div>
            <div class="chip active" data-type="post">Post</div>
            <div class="chip active" data-type="share">Share</div>
          </div>
        </div>
        <div class="fld" style="grid-column:span 6;align-self:end">
          <label>Tùy chọn</label>
          <div class="chips">
            <div class="chip" id="autoRefresh">Tự động cập nhật 30s</div>
            <div class="chip" id="onlyFlagged">Chỉ hiển thị có từ khóa nhạy cảm</div>
          </div>
        </div>
        <div class="fld" style="grid-column:span 6;align-self:end;display:flex;gap:10px;justify-content:flex-end">
          <button class="btn" id="exportCsv">Xuất CSV</button>
          <button class="btn" id="resetBtn">Đặt lại</button>
          <button class="btn primary" id="applyBtn">Áp dụng</button>
        </div>
      </div>
    </section>

    <!-- Stats -->
    <section class="grid" style="margin:16px 0">
      <div class="card stat"><div class="k" id="k-total">0</div><div class="t">Tổng sự kiện</div></div>
      <div class="card stat"><div class="k" id="k-comments">0</div><div class="t">Bình luận</div></div>
      <div class="card stat"><div class="k" id="k-reactions">0</div><div class="t">Reaction</div></div>
      <div class="card stat"><div class="k" id="k-unique">0</div><div class="t">Số người tương tác</div></div>
    </section>

    <!-- Chart -->
    <section class="card">
      <h3 style="margin:0 0 10px;font-size:16px">Biểu đồ theo ngày</h3>
      <div style="height:260px"><canvas id="lineChart"></canvas></div>
    </section>

    <!-- Table -->
    <section class="card" style="margin-top:12px">
      <h3 style="margin:0 0 10px;font-size:16px">Danh sách tương tác</h3>
      <div style="overflow-x:auto">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Thời gian</th><th>Loại</th><th>Người</th><th>Nội dung</th><th>Page</th><th>Post</th><th>Hành động</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <button class="btn" id="prevBtn" disabled>◀ Trước</button>
        <div id="pageInfo" style="opacity:.75"></div>
        <button class="btn" id="nextBtn">Tiếp ▶</button>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // ================= CONFIG =================
    const CONFIG = {
      API_BASE: 'https://script.google.com/macros/s/REPLACE_WITH_YOUR_PTQV3_API/exec', // ⚠️ thay bằng URL Web App thật
      BEARER: '',
      AUTO_REFRESH_MS: 30000,
      PROXY_URL: '',                  // tuỳ chọn: 'https://your-proxy.workers.dev/?url='
      ALLOW_DEMO_FALLBACK: true,      // bật demo khi API chưa sẵn sàng/CORS
      PING_PARAM: 'fn=ping'
    };

    // ================= STATE =================
    const state = {
      from: isoDateOffset(-7), to: isoDateOffset(0), pageId: '', q: '',
      types: new Set(['comment','reaction','post','share']), onlyFlagged:false,
      limit:100, cursor:'', page:1, items:[], nextCursor:'', timer:null,
      source:'', error:''
    };

    // ================= INIT =================
    document.addEventListener('DOMContentLoaded', () => {
      $('#fromDate').value = state.from; $('#toDate').value = state.to;
      $('#applyBtn').addEventListener('click', applyFilters);
      $('#resetBtn').addEventListener('click', resetFilters);
      $('#exportCsv').addEventListener('click', exportCsv);
      $('#nextBtn').addEventListener('click', ()=> loadPage('next'));
      $('#prevBtn').addEventListener('click', ()=> loadPage('prev'));
      $('#autoRefresh').addEventListener('click', (e)=>{ e.target.classList.toggle('active'); setupAuto(e.target.classList.contains('active'));});
      $('#onlyFlagged').addEventListener('click', (e)=> e.target.classList.toggle('active'));
      $$('#types .chip').forEach(ch=> ch.addEventListener('click', ()=>{ ch.classList.toggle('active'); const t=ch.dataset.type; if(ch.classList.contains('active')) state.types.add(t); else state.types.delete(t); }));

      // Self-tests (nhỏ)
      (function tests(){
        assert('truncate long', truncate('abcdefgh',5)==='abcd…');
        assert('guessType comment', guessType({field:'comments'})==='comment');
        assert('isoDateOffset format', /^\d{4}-\d{2}-\d{2}$/.test(isoDateOffset(0)));
      })();

      applyFilters();
    });

    // ================= CORE =================
    async function applyFilters(){
      state.from = $('#fromDate').value || state.from; state.to = $('#toDate').value || state.to;
      state.pageId = $('#pageSelect').value || ''; state.q = $('#keyword').value.trim();
      state.onlyFlagged = $('#onlyFlagged').classList.contains('active'); state.cursor=''; state.page=1;
      await fetchData();
    }

    async function loadPage(dir){ if(dir==='next' && state.nextCursor){ state.cursor=state.nextCursor; state.page++; await fetchData(); } }

    function buildParams(){
      const p = new URLSearchParams();
      p.set('fn','fb_events'); p.set('limit', state.limit);
      if(state.from) p.set('from', state.from); if(state.to) p.set('to', state.to);
      if(state.pageId) p.set('page_id', state.pageId); if(state.q) p.set('q', state.q);
      const t = Array.from(state.types).join(','); if(t) p.set('types', t);
      if(state.cursor) p.set('cursor', state.cursor);
      if(state.onlyFlagged) p.set('only_flagged','1');
      return p;
    }

    async function fetchData(){
      setLoading(true); banner('');
      try{
        const {items,next_cursor,source} = await fetchEvents(buildParams());
        const norm = normalizeItems(items);
        state.items = norm; state.nextCursor = next_cursor || ''; state.source = source || '';
        hydrateFilters(norm); renderStats(norm); renderTable(norm); renderChart(norm);
        $('#pageInfo').textContent = `Trang ${state.page}${state.nextCursor?' — có thêm dữ liệu':''}`;
        $('#prevBtn').disabled = true; // server chưa hỗ trợ prev cursor
      }catch(err){ console.error(err); banner(`Lỗi: ${err?.message||err}`,'err'); if(!CONFIG.ALLOW_DEMO_FALLBACK) alert('Không tải được dữ liệu. Kiểm tra API_BASE hoặc CORS.'); }
      finally{ setLoading(false); }
    }

    async function fetchEvents(params){
      const headers = { 'Accept':'application/json' };
      if(CONFIG.BEARER) headers['Authorization'] = `Bearer ${CONFIG.BEARER}`;
      const apiUnset = !CONFIG.API_BASE || CONFIG.API_BASE.includes('REPLACE_WITH_YOUR_PTQV3_API');
      if(apiUnset && CONFIG.ALLOW_DEMO_FALLBACK){ return { items: demoItems(), next_cursor:'', source:'demo' } }

      const base = CONFIG.API_BASE.replace(/\/?$/, '');
      const url = `${base}?${params.toString()}`;

      // ping
      try{ await fetchJSON(`${base}?${CONFIG.PING_PARAM}`, headers, 6000); }
      catch(e){
        if(CONFIG.PROXY_URL){
          try{
            const pingProxy = `${CONFIG.PROXY_URL}${encodeURIComponent(`${base}?${CONFIG.PING_PARAM}`)}`;
            await fetchJSON(pingProxy, headers, 8000);
            const via = `${CONFIG.PROXY_URL}${encodeURIComponent(url)}`;
            const j = await fetchJSON(via, headers, 15000);
            return { items:(j.items||j.data||[]), next_cursor:j.next_cursor, source:'proxy' };
          }catch(e2){ if(CONFIG.ALLOW_DEMO_FALLBACK) return { items:demoItems(), next_cursor:'', source:'demo' }; throw e2; }
        }
        if(CONFIG.ALLOW_DEMO_FALLBACK) return { items:demoItems(), next_cursor:'', source:'demo' };
        throw e;
      }
      // direct
      try{ const j = await fetchJSON(url, headers, 15000); return { items:(j.items||j.data||[]), next_cursor:j.next_cursor, source:'direct' } }
      catch(e){
        if(CONFIG.PROXY_URL){ try{ const via = `${CONFIG.PROXY_URL}${encodeURIComponent(url)}`; const j = await fetchJSON(via, headers, 15000); return { items:(j.items||j.data||[]), next_cursor:j.next_cursor, source:'proxy' } } catch(e2){ if(CONFIG.ALLOW_DEMO_FALLBACK) return { items:demoItems(), next_cursor:'', source:'demo' }; throw e2; } }
        if(CONFIG.ALLOW_DEMO_FALLBACK) return { items:demoItems(), next_cursor:'', source:'demo' };
        throw e;
      }
    }

    // ===== Helpers =====
    function $(sel){ return document.querySelector(sel) }
    function $$(sel){ return Array.from(document.querySelectorAll(sel)) }
    function setLoading(v){ document.body.style.cursor = v? 'progress':'default' }
    function isoDateOffset(days){ const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10) }
    function fmtTime(t){ try{ const d=new Date(t); return d.toLocaleString('vi-VN') }catch{ return String(t) } }
    function truncate(s,n){ return s && s.length>n ? s.slice(0,n-1)+'…' : (s||'') }
    function assert(name,cond){ if(!cond) throw new Error('Test failed: '+name) }
    function guessType(x){ const f=(x.Field||x.field||'').toLowerCase(); const it=(x.Item||x.item||'').toLowerCase(); if(f.includes('comment')||it.includes('comment')) return 'comment'; if(f.includes('reaction')||it.includes('reaction')||x.reaction_type) return 'reaction'; if(f.includes('share')||it.includes('share')) return 'share'; return 'post' }
    function normalizeItems(arr){ return arr.map(x=>({ created: String(x.CreatedTime||x.created_time||x.time||x.timestamp||x.ReceivedAt||new Date().toISOString()), type: guessType(x), pageId: x.PageId||x.page_id||x.owner_id||'', postId: x.PostId||x.post_id||x.id||'', userName: x.UserName|| (x.from && (x.from.name||x.from.username)) || x.user_name || '', userId: x.UserId || (x.from && x.from.id) || x.user_id || '', message: x.Message||x.message||x.body||x.text||'', verb: x.Verb||x.verb||'', raw:x })) }

    function hydrateFilters(items){
      const sel = $('#pageSelect');
      const exist = new Set(Array.from(sel.options).map(o=>o.value));
      items.forEach(it=>{ if(it.pageId && !exist.has(it.pageId)){ const op=document.createElement('option'); op.value=it.pageId; op.textContent=it.pageId; sel.appendChild(op); exist.add(it.pageId);} });
    }
    function renderStats(items){
      const total=items.length; const comments=items.filter(i=>i.type==='comment').length; const reactions=items.filter(i=>i.type==='reaction').length; const uniq=new Set(items.map(i=>i.userId||i.userName).filter(Boolean)).size;
      $('#k-total').textContent=total.toLocaleString('vi-VN'); $('#k-comments').textContent=comments.toLocaleString('vi-VN'); $('#k-reactions').textContent=reactions.toLocaleString('vi-VN'); $('#k-unique').textContent=uniq.toLocaleString('vi-VN');
    }
    function renderTable(items){
      const tbody = $('#dataTable tbody'); tbody.innerHTML='';
      items.forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtTime(it.created)}</td>
          <td>${pill(it.type)}</td>
          <td>${escapeHtml(it.userName||'')}</td>
          <td>${escapeHtml(truncate(it.message||'',120))}</td>
          <td>${escapeHtml(it.pageId||'')}</td>
          <td>${it.postId?`<a class="link" target="_blank" rel="noopener" href="https://www.facebook.com/${encodeURIComponent(it.postId)}">Mở post</a>`:'—'}</td>
          <td>${it.postId?`<a class="link" target="_blank" rel="noopener" href="https://www.facebook.com/${encodeURIComponent(it.postId)}">Xem</a>`:'—'}</td>`;
        tbody.appendChild(tr);
      });
    }
    function renderChart(items){
      const byDay={}; items.forEach(it=>{ const d=new Date(it.created).toISOString().slice(0,10); byDay[d]=(byDay[d]||0)+1; });
      const labels=Object.keys(byDay).sort(); const data=labels.map(l=>byDay[l]);
      if(window.__chart){ window.__chart.destroy(); }
      const ctx=document.getElementById('lineChart');
      window.__chart=new Chart(ctx,{ type:'line', data:{ labels, datasets:[{ label:'Sự kiện', data }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } } });
    }
    function pill(type){ const color={comment:'#eef6ff',reaction:'#fff7ed',share:'#f5f3ff',post:'#f0fdf4'}[type]||'#f0fdf4'; return `<span style="display:inline-flex;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:${color}">${type[0].toUpperCase()+type.slice(1)}</span>` }
    function escapeHtml(s){ return s.replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])) }

    function banner(msg,type){ const el=$('#banner'); if(!msg){ el.innerHTML=''; return } const cls= type==='err'?'err': (type==='info'?'info':'warn'); el.innerHTML = `<div class="${cls}">${msg}</div>` }

    function setupAuto(on){ if(state.timer){ clearInterval(state.timer); state.timer=null; } if(on){ state.timer=setInterval(()=> fetchData(), CONFIG.AUTO_REFRESH_MS); }}

    function exportCsv(){ if(!state.items.length){ alert('Không có dữ liệu để xuất.'); return; }
      const headers=['Thời gian','Loại','Người','UserId','Nội dung','PageId','PostId'];
      const rows=state.items.map(i=>[fmtTime(i.created), i.type, i.userName||'', i.userId||'', (i.message||'').replace(/\n/g,' '), i.pageId||'', i.postId||'']);
      const csv=[headers.join(','), ...rows.map(r=> r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(','))].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`ptkv3_fb_${state.from}_${state.to}.csv`; a.click(); URL.revokeObjectURL(url);
    }

    async function fetchJSON(url, headers, timeoutMs){
      const res = await fetch(url,{ headers, cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    function demoItems(){
      const now=new Date(); const day=i=> new Date(now.getTime()-i*86400000).toISOString();
      return [
        { created_time: day(0), field:'comments', post_id:'123_1', from:{id:'u01',name:'Nguyễn A'}, message:'Ý kiến rất hay' },
        { created_time: day(1), field:'reaction', item:'reaction', post_id:'123_1', from:{id:'u02',name:'Trần B'}, reaction_type:'LIKE' },
        { created_time: day(1), field:'share', item:'share', post_id:'123_2', from:{id:'u03',name:'Lê C'} },
        { created_time: day(2), field:'feed', item:'post', id:'123_3', from:{id:'u04',name:'Phạm D'}, message:'Bài viết mới' }
      ];
    }
  </script>
</body>
</html>
