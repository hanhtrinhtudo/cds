<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PTKV3 ‚Ä¢ L√†m b√†i ki·ªÉm tra</title>
<link rel="stylesheet" href="css/nav.css?v=20251006">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
/* ===== NAVBAR (ƒë·ªôc l·∫≠p) ===== */
:root{--gold:#FFD966; --red-a:#7f1d1d; --red-b:#b91c1c; --red-c:#dc2626;
  --topbar-grad: linear-gradient(90deg, var(--red-a) 0%, var(--red-b) 45%, var(--red-c) 100%);}; 
*{box-sizing:border-box}
html,body{height:100%}
body{min-height:100vh; display:flex; flex-direction:column; margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
main.page{flex:1 0 auto;}
a{color:inherit;text-decoration:none}

/* Top bar */
.header{position:sticky;top:0;z-index:50; font-weight: 600;  background: var(--topbar-grad); border-bottom: 2px solid #FFD74B;}
.nav{  max-width:1200px; margin:auto;
  height:56px;
  padding:0px 16px;
  display:flex; align-items:center; gap:18px;
  font-size:16px; line-height:1;
  font-weight:600;}
.nav a:hover{color:var(--gold); transform:scale(1.06);}
.brand{font-weight:800; letter-spacing:0.2px}
.nav a{ color:#fff; padding:6px 12px; border-radius:12px;}

.nav .is-active{background: rgba(0,0,0,.15);box-shadow:0 4px 12px rgba(0,0,0,.18)}

.m-toggle{margin-left:auto;background:transparent;border:0;color:#fff;font-size:28px;display:none}
/* Drawer mobile */
@media (max-width:1024px){
  .nav a:not(.brand),.has-dropdown{display:none}
  .m-toggle{display:block}
  .drawer{position:fixed;inset:0 auto 0 0;width:86vw;max-width:420px;background:linear-gradient(180deg,#7f1d1d,#b91c1c 55%,#9d1414);color:#fff;transform:translateX(-100%);transition:.25s;z-index:60;box-shadow:4px 0 30px rgba(0,0,0,.25)}
  .drawer.open{transform:translateX(0)}
  .d-head{display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.12)}
  .d-menu{padding:8px}
  .d-item{display:block;color:#fff;padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:55;opacity:0;pointer-events:none;transition:.25s}
  .backdrop.open{opacity:1;pointer-events:auto}
}
/* ·∫®n ch·∫Øc ch·∫Øn drawer/backdrop tr√™n desktop */
@media (min-width:1025px){ .drawer,.backdrop{display:none !important;transform:none !important} }

/* ===== PAGE BACKGROUND ===== */
.page{
  background:
    linear-gradient(90deg, var(--red-a) 0%, var(--red-b) 45%, var(--red-c) 100%),
    radial-gradient(900px 420px at 12% 15%, rgba(255,255,255,.06) 0%, transparent 70%),
    radial-gradient(900px 420px at 88% 25%, rgba(0,0,0,.12) 0%, transparent 65%);
  min-height:100svh;
  color:#0f172a;
}
body.bg-red{
  background:
    linear-gradient(90deg, var(--red-a) 0%, var(--red-b) 45%, var(--red-c) 100%),
    radial-gradient(900px 420px at 12% 15%, rgba(255,255,255,.06) 0%, transparent 70%),
    radial-gradient(900px 420px at 88% 25%, rgba(0,0,0,.12) 0%, transparent 65%);
}
/* ===== HERO ===== */
.hero{max-width:1200px;margin:0 auto;padding:16px 16px 8px;color:#fff}
.hero h1{margin:6px 0;font-size:clamp(28px,4vw,48px);line-height:1.08;color:#F3C63F;font-weight:800}
.hero p{margin:0;color:#FFE6BF}

/* ===== GRID ===== */
.grid{max-width:1200px;margin:22px auto;padding:0 16px 20px;display:grid;gap:22px;grid-template-columns:1fr}
@media (min-width:768px){.grid{grid-template-columns:1fr 1fr}}
@media (min-width:1100px){.grid{grid-template-columns:1fr 1fr 1fr}}

/* ===== CARD ===== */
.card{
  background:#fffaf0;
  border:3px solid #FFD74B;
  box-shadow:0 0 12px rgba(255,215,75,.35);
  border-radius:14px;
  padding:18px 18px 14px;
  height:260px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.card__title{margin:0;font-size:22px;font-weight:800;color:#1a1d25}
.meta{display:grid;gap:8px;font-size:15px;color:#1f2937}
.row{display:flex;align-items:center;gap:10px}
.icon{width:18px;height:18px;display:inline-block}
/* Badge tr·∫°ng th√°i 1 d√≤ng: ch·ªØ v√†ng, n·ªÅn ƒë·ªè */
.status-badge{
  display:inline-block; white-space:nowrap;
  margin-left:8px; padding:2px 10px; border-radius:999px;
  font-weight:600; font-size:12px;
  background:#C62828;
  color:#FFD966;
  border:1px solid #FFD74B;
  box-shadow:0 0 6px rgba(255,215,75,.35);
}

/* Buttons ‚Äì ƒë·ªìng b·ªô, ring m·∫£nh, cƒÉn gi·ªØa & th·∫≥ng h√†ng */
.actions{
  margin-top:16px;
  display:flex;
  justify-content:center;
  gap:8px;
}
.actions-multi{
  flex-direction:column;
  align-items:center;
}
.btn{
  min-width: 180px;
  padding: 8px 14px;
  font-size: 16px;
  font-weight: 700;
  border-radius: 8px;
  text-transform: uppercase;
  border: 2px solid #FFD74B;
  background: #C62828;
  color: #fff;
  box-shadow: 0 0 6px rgba(255,215,75,.4);
  transition: all .2s ease;
}
.btn:active{transform:translateY(1px)}
.btn-primary, .btn-ghost{
  background:#C62828;
  color:#fff;
  border:2px solid #FFD74B;
  box-shadow:0 0 8px rgba(255,215,75,.5);
}
.btn-primary:hover, .btn-ghost:hover{
  filter:brightness(1.1);
}

/* Footer */
.footer{color:#FFE6A6;text-align:center;padding:14px 16px 18px;border-top:1px solid rgba(255,255,255,.12)}

/* === FIX MOBILE: thu g·ªçn kho·∫£ng tr·ªëng gi·ªØa HERO v√† GRID === */
@media (max-width: 768px){
  .hero{
    min-height: unset !important;
    padding-top: 12px !important;
    padding-bottom: 4px !important;
    margin-bottom: 0 !important;
  }
  .hero h1{ margin: 4px 0 6px !important; font-size: 26px; line-height: 1.15; }
  .hero p { margin: 0 !important; }

  .hero + .grid{
    margin-top: 8px !important;
    padding-top: 0 !important;
  }

  .grid{ display:block; }

  .card{
    height: auto;
    padding: 14px 14px 12px;
  }
  .card .actions{ margin-top: 12px; }
  .btn{ min-width: 160px; padding: 8px 12px; font-size: 14px; }
}
/* === MOBILE: th√™m kho·∫£ng c√°ch gi·ªØa c√°c √¥ k·ª≥ thi === */
@media (max-width: 768px){
  .grid{
    display: grid !important;
    grid-template-columns: 1fr;
    row-gap: 16px;
    column-gap: 0;
    margin-top: 10px !important;
  }
  .card{
    height: auto;
    padding: 14px 14px 12px;
    margin: 0;
  }
}
</style>
</head>
<body>
<script>
(function(){
  try{
    const t = localStorage.getItem('ctct_token') || sessionStorage.getItem('ctct_token');
    if(!t || t === 'null' || t === 'undefined'){
      const back = encodeURIComponent(location.href);
      location.replace(`login.html?redirect=${back}`);
    }
  }catch(e){}
})();
</script>

<!-- ===== NAVBAR ===== -->
<header class="header">
  <nav class="nav">
    <a class="brand">BAN CH·ªà HUY PTKV3</a>
    <a href="index.html">Trang ch·ªß</a>
    <a href="tintuc24.html">Tin t·ª©c</a>
    <a href="Hoctap.html">H·ªçc t·∫≠p</a>
    <a href="#" aria-current="page" style="background:rgba(31, 28, 28, 0.18)">Ki·ªÉm tra</a>
    <div class="sp"></div>
    <button id="hamburger" class="m-toggle" aria-label="M·ªü menu">‚ò∞</button>
  </nav>

  <!-- Drawer mobile -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="d-head">
      <strong>B·ªò CHQS T·ªàNH B·∫ÆC NINH</strong>
      <button id="close" style="margin-left:auto;background:0 0;border:0;color:#fff;font-size:26px">‚úï</button>
    </div>
    <nav class="d-menu">
      <a class="d-item" href="index.html">Trang ch·ªß</a>
      <a class="d-item" href="tintuc24.html">Tin t·ª©c</a>
      <a class="d-item" href="Hoctap.html">H·ªçc t·∫≠p</a>
      <a class="d-item" href="kiemtra.html" aria-current="page" style="background:rgba(255,255,255,.16);border-left:3px solid var(--gold);font-weight:800">L√†m b√†i ki·ªÉm tra</a>
    </nav>
  </div>
  <div id="backdrop" class="backdrop"></div>
</header>

<!-- ===== PAGE ===== -->
<main class="page">
  <section class="hero">
    <h1>KI·ªÇM TRA & THI</h1>
    <p>ƒê√°nh gi√° nh·∫≠n th·ª©c ‚Äì Ki·ªÉm tra k·∫øt qu·∫£ hu·∫•n luy·ªán</p>
  </section>

  <section class="grid" id="exam-grid">
    <!-- Fallback khi ƒëang t·∫£i -->
    <article class="card" id="loading-card">
      <header class="row" style="align-items:flex-start">
        <h2 class="card__title">ƒêang t·∫£i danh s√°ch k·ª≥ thi‚Ä¶</h2>
      </header>
      <div class="meta loading">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t.</div>
      <div class="actions"><button class="btn btn-primary" disabled>ƒêANG T·∫¢I</button></div>
    </article>
  </section>

  <footer class="footer">¬© PTKV3 ‚Äì Trung t√¢m Gi√°o d·ª•c Ch√≠nh tr·ªã S·ªë</footer>
</main>

<!-- ====== PTKV3 CORE (startExam) ====== -->
<script>
window.PTKV3_CFG = {
  RESULT_PAGE: "ketqua.html",
  EXAM_PAGE:   "lambai.html",
  SUBMIT_URL:  "",
  USE_QUEUE:   true
};

(function(){
  const KEYS = { CURRENT:"ptkv3:exam:current" };
  function save(k,v){ try{ sessionStorage.setItem(k, JSON.stringify(v)); }catch(e){} }

  window.PTKV3 = window.PTKV3 || {};
  window.PTKV3.startExam = function(meta){
    const cfg = {
      mode: meta.mode || "exam",
      bankId: meta.bankId || "UNKNOWN",
      title: meta.title || "",
      total: Number(meta.total || 0),
      durationSec: Number(meta.durationSec || 0) || null,
      startedAt: Date.now(),
      user: meta.user || null,
      target: meta.target || ""   // üîπ ƒê·ªëi t∆∞·ª£ng: SQ / QNCN / CBQNCN...
    };
    save(KEYS.CURRENT, cfg);

    const p = new URLSearchParams({ bank: cfg.bankId, mode: cfg.mode });
    if (cfg.target) p.set('target', cfg.target);   // g·ª≠i k√®m sang lambai.html
    location.href = window.PTKV3_CFG.EXAM_PAGE + "?" + p.toString();
  };
})();
</script>

<!-- ====== Render ƒë·ªông t·ª´ Apps Script: listBanks ====== -->
<script>
const API = 'https://script.google.com/macros/s/AKfycbwgpyEWzRG-wpqFSrYVzWiklxda-DY68LN-FHAw1rnd1rON5MBegLfx7gtFOWbUFtteYg/exec';
const grid = document.getElementById('exam-grid');

function fmtLocal(s){ return s && String(s).trim() ? s : '‚Äî'; }

function escapeHTML(s){
  return String(s||'').replace(/[&<>"']/g,c=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"
  }[c]));
}

function mmss(sec){
  sec = Number(sec||0);
  const m = Math.floor(sec/60), s = sec%60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* G√°n handler cho n√∫t b·∫Øt ƒë·∫ßu, c√≥ c·∫£ target */
function attachStartHandlers(scope){
  scope.querySelectorAll('button[data-bank]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(btn.classList.contains('is-disabled')) return;
      PTKV3.startExam({
        bankId: btn.dataset.bank,
        title: btn.dataset.title,
        total: Number(btn.dataset.total||0),
        durationSec: Number(btn.dataset.duration||0) || null,
        mode: btn.dataset.mode || 'exam',
        target: btn.dataset.target || ''
      });
    });
  });
}

/* Render danh s√°ch banks
   - N·∫øu bank.targets.length > 1 -> t√°ch th√†nh nhi·ªÅu card (SQ, QNCN...)
   - N·∫øu kh√¥ng c√≥ ho·∫∑c ch·ªâ 1 target -> 1 card nh∆∞ b√¨nh th∆∞·ªùng
*/
function renderBanks(banks){
  grid.innerHTML = '';
  if(!banks.length){
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <header class="row" style="align-items:flex-start">
        <h2 class="card__title">Ch∆∞a c√≥ k·ª≥ ki·ªÉm tra</h2>
      </header>
      <div class="meta">Ki·ªÉm tra b·∫£ng <strong>Banks</strong> trong Google Sheet ho·∫∑c th·ªùi gian m·ªü k·ª≥ thi.</div>
      <div class="actions"><button class="btn" disabled>‚Äî</button></div>`;
    grid.appendChild(card);
    return;
  }
  banks.forEach(b=>{
    const targets = Array.isArray(b.targets) ? b.targets : [];
    const status = b.status || 'open';
    const badge = (status==='open') ? '' :
      `<span class="status-badge">${status==='upcoming'?'S·∫ÆP M·ªû':'ƒê√É K·∫æT TH√öC'}</span>`;
    const btnDisabled = status!=='open';
    const override = Number(b.totalOverride || 0);

    // h√†m t√≠nh s·ªë c√¢u hi·ªÉn th·ªã, ∆∞u ti√™n min(questionCount, totalOverride)
    const calcTotal = (t)=>{
      let base = Number(t?.questionCount || b.questionCount || 0) || 0;
      if(override > 0){
        if(base > 0) return Math.min(base, override);
        return override;
      }
      return base || '‚Äî';
    };

    const btnLabel = (b.mode==='mock') ? 'B·∫ÆT ƒê·∫¶U THI' : 'B·∫ÆT ƒê·∫¶U KI·ªÇM TRA';

    // N·∫øu 0 ho·∫∑c 1 ƒë·ªëi t∆∞·ª£ng -> 1 card
    if(!targets.length || targets.length===1){
      const t = targets[0] || { key:'', label:'C√°n b·ªô, QNCN' };
      const total = calcTotal(t);

      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <header class="row" style="align-items:flex-start">
          <h2 class="card__title">${escapeHTML(b.title)}</h2>${badge}
        </header>
        <div class="meta">
          <div class="row"><span class="icon">üéØ</span><span>ƒê·ªëi t∆∞·ª£ng: <strong>${escapeHTML(t.label||'C√°n b·ªô, QNCN')}</strong></span></div>
          <div class="row"><span class="icon">üìÖ</span><span>B·∫Øt ƒë·∫ßu: ${fmtLocal(b.startAtLocal)}</span></div>
          <div class="row"><span class="icon">‚è∞</span><span>K·∫øt th√∫c: ${fmtLocal(b.endAtLocal)}</span></div>
          <div class="row"><span class="icon">üìÑ</span><span>${total} c√¢u h·ªèi</span></div>
        </div>
        <div class="actions">
          <button class="btn ${btnDisabled?'is-disabled':''}"
            ${btnDisabled?'disabled':''}
            data-bank="${b.bankId}"
            data-title="${escapeHTML(b.title)}"
            data-total="${total || 0}"
            data-duration="${b.durationSec||''}"
            data-mode="${b.mode||'exam'}"
            data-target="${t.key||''}">
            ${btnLabel}
          </button>
        </div>`;
      grid.appendChild(card);
    }else{
      // Nhi·ªÅu ƒë·ªëi t∆∞·ª£ng -> m·ªói ƒë·ªëi t∆∞·ª£ng 1 card
      targets.forEach(t=>{
        const total = calcTotal(t);

        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <header class="row" style="align-items:flex-start">
            <h2 class="card__title">${escapeHTML(b.title)}</h2>${badge}
          </header>
          <div class="meta">
            <div class="row"><span class="icon">üéØ</span><span>ƒê·ªëi t∆∞·ª£ng: <strong>${escapeHTML(t.label||'')}</strong></span></div>
            <div class="row"><span class="icon">üìÖ</span><span>B·∫Øt ƒë·∫ßu: ${fmtLocal(b.startAtLocal)}</span></div>
            <div class="row"><span class="icon">‚è∞</span><span>K·∫øt th√∫c: ${fmtLocal(b.endAtLocal)}</span></div>
            <div class="row"><span class="icon">üìÑ</span><span>${total} c√¢u h·ªèi</span></div>
          </div>
          <div class="actions">
            <button class="btn ${btnDisabled?'is-disabled':''}"
              ${btnDisabled?'disabled':''}
              data-bank="${b.bankId}"
              data-title="${escapeHTML(b.title)}"
              data-total="${total || 0}"
              data-duration="${b.durationSec||''}"
              data-mode="${b.mode||'exam'}"
              data-target="${t.key||''}">
              ${btnLabel}
            </button>
          </div>`;
        grid.appendChild(card);
      });
    }
  });

  attachStartHandlers(grid);
}

/* Load banks */
async function loadBanks(){
  try{
    const res = await fetch(`${API}?action=listBanks`, {cache:'no-store'});
    const data = await res.json();
    if(!data.ok || !Array.isArray(data.banks)) throw new Error(data.error || 'listBanks failed');
    renderBanks(data.banks);
  }catch(e){
    console.error(e);
    const loading = document.getElementById('loading-card'); if(loading) loading.remove();
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <header class="row" style="align-items:flex-start">
        <h2 class="card__title">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</h2>
      </header>
      <div class="meta">
        <div class="row"><span class="icon">‚ÑπÔ∏è</span>
          <span>M√°y ch·ªß ch∆∞a ph·∫£n h·ªìi. Vui l√≤ng ki·ªÉm tra quy·ªÅn Web App ho·∫∑c th·ª≠ t·∫£i l·∫°i sau √≠t ph√∫t.</span>
        </div>
      </div>
      <div class="actions"><a class="btn" href="kiemtra.html">T·∫¢I L·∫†I</a></div>`;
    grid.appendChild(card);
  }
}
loadBanks();

/* Drawer mobile nh·ªè g·ªçn (gi·ªØ nguy√™n h√†nh vi) */
const d=document,drawer=d.getElementById('drawer'),bd=d.getElementById('backdrop');
d.getElementById('hamburger')?.addEventListener('click',()=>{drawer.classList.add('open');bd.classList.add('open')});
d.getElementById('close')?.addEventListener('click',()=>{drawer.classList.remove('open');bd.classList.remove('open')});
bd?.addEventListener('click',()=>{drawer.classList.remove('open');bd.classList.remove('open')});
</script>
<script>
function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[c]));}
</script>
</body>
</html>
