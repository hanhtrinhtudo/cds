<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PTKV3 • Đăng nhập / Đăng ký</title>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --ptk-red:#A41919; --ptk-gold:#FFD966;
      --ptk-gold-400:#FFE9A6; --ptk-purple:#3018A5;
      --text:#101828; --muted:#6B7280;
      --shadow-lg:0 20px 60px rgba(16,24,40,.18);
      --hero-w:610px; --hero-h:780px; --card-w:400px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; display:flex; flex-direction:column; min-height:100svh;
      font-family:"Be Vietnam Pro",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:#fff;
      background:
        radial-gradient(1000px 480px at 50% 38%, rgba(255,217,102,.22), rgba(255,217,102,0) 60%),
        linear-gradient(90deg, var(--ptk-red) 0%, #CA5A1E 55%, var(--ptk-gold) 100%);
    }

    main{flex:1; display:flex; align-items:center; justify-content:center; padding:24px}
    .hero{
      width:100%; max-width:var(--hero-w); height:var(--hero-h);
      display:flex; flex-direction:column; align-items:center;
      padding:28px clamp(18px,4vw,36px);
      border-radius:28px;
      border:2px solid rgba(255,217,102,.85);
      background:linear-gradient(180deg,#9c0f0f 0%,#8a0a0a 100%);
      box-shadow:0 18px 60px rgba(0,0,0,.25);
    }

    .hero h2{
      margin:0 0 0; font-size:28px; line-height:1.2; font-weight:800; text-align: center;
      background:linear-gradient(90deg,#FFE082,#FFD54F,#FFCA28);
      -webkit-background-clip:text; background-clip:text; color:rgb(255, 204, 0);
    }
    .hero .lead{
      margin:6px 0 12px; font-size:16px; font-weight:600; color:rgb(255, 204, 0);
      text-shadow:0 1px 2px rgba(0,0,0,.25);
    }
    .hero .quote{
      font-size:18px; font-style: italic; font-weight:600; color: #fff;
      margin:0px 40 28px; text-align:center;
    }

    .auth-card{
      width:100%; max-width:var(--card-w);
      background:rgba(255,255,255,.9); backdrop-filter:blur(6px);
      color:var(--text);
      border-radius:18px; padding:22px 22px 18px;
      border:1px solid rgba(15,23,42,.06); box-shadow:var(--shadow-lg);
      display:flex; flex-direction:column;
    }
    .auth-card h3{margin:2px 0 6px; font-size:18px; color:#111}
    .muted-small{color:var(--muted); font-size:13px; text-align: center;}
    .tabs{display:flex;gap:10px;margin:12px 0 18px}
    .tab{
      flex:1; text-align:center; padding:10px 12px; border-radius:999px;
      cursor:pointer; font-weight:800;
      color:#7C8698; background:#F3F5F8; border:1px solid #E6E9F0;
      transition:all .18s ease;
    }
    .tab.active{
      color:#fff; background:linear-gradient(90deg,var(--ptk-red),#E04B2D);
      border-color:transparent; box-shadow:0 8px 22px rgba(164,25,25,.25);
      transform:translateY(-1px);
    }
    .field{margin-bottom:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;font-weight:700}
    input[type="text"],input[type="password"]{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid #E7ECF2; background:#fff; font-size:15px;
      outline:none; transition:border-color .14s, box-shadow .14s;
    }
    input:focus{border-color:#FFD45A; box-shadow:0 0 0 3px rgba(255,217,102,.25)}
    .checkbox{display:flex;gap:8px;align-items:center}
    .btn{
      display:inline-block;padding:12px 18px;border-radius:12px;
      border:none;cursor:pointer;font-weight:800;
      background:var(--ptk-red); color:#fff;
      box-shadow:0 10px 24px rgba(164,25,25,.22);
    }
    .btn:hover{filter:brightness(1.02)}
    .linkless{color:var(--ptk-red);font-weight:700;text-decoration:none}
    .error{color:#B91C1C;font-size:13px;margin-top:6px}

    footer.site-footer{
      background:#0E1A2B; color:#fff; padding:18px 24px;
      text-align:center; font-weight:700; margin-top:auto;
    }

    @media (max-width:640px){
      :root{--hero-h:auto;}
      main{padding:12px}
      .hero{height:auto}
      .auth-card{padding:16px}
    }
  </style>
</head>
<body>

  <main>
    <section class="hero" aria-labelledby="hero-title">
      <h2 id="hero-title">TRUNG TÂM GIÁO DỤC CHÍNH TRỊ SỐ</h2>
      <p class="lead">Nền tảng học tập & kiểm tra chính trị số</p>
      <p class="quote">“Học tập chính trị là vun đắp niềm tin – rèn luyện bản lĩnh – phụng sự Tổ quốc.”</p>

      <!-- Card -->
      <aside class="auth-card" aria-labelledby="auth-title">
        <div>
          <div class="muted-small">Bạn chưa có tài khoản vui lòng chọn “Đăng ký”.</div>
        </div>

        <div class="tabs" role="tablist">
          <button class="tab active" data-target="login-pane">Đăng nhập</button>
          <button class="tab" data-target="signup-pane">Đăng ký</button>
        </div>

        <!-- Đăng nhập -->
        <form id="login-pane" class="pane" autocomplete="on" novalidate>
          <div class="field">
            <label for="li-username">Tài khoản</label>
            <input id="li-username" name="username" type="text" placeholder="Nhập tài khoản" required>
          </div>
          <div class="field">
            <label for="li-password">Mật khẩu</label>
            <input id="li-password" name="password" type="password" placeholder="Nhập mật khẩu" required minlength="6">
            <div class="hint" style="margin-top:6px"><a href="#" class="linkless" id="forgot-link">Quên mật khẩu?</a></div>
          </div>
          <div class="field" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <label class="checkbox" for="li-remember" style="margin:0">
              <input id="li-remember" type="checkbox" />
              <span style="font-weight:600;color:var(--muted)">Ghi nhớ đăng nhập</span>
            </label>
            <button type="submit" class="btn">Đăng nhập</button>
          </div>
          <div id="login-error" class="error" style="display:none"></div>
        </form>

        <!-- Đăng ký -->
        <form id="signup-pane" class="pane" style="display:none" autocomplete="on" novalidate>
          <div class="field"><label for="su-name">Họ và tên</label>
            <input id="su-name" name="name" type="text" placeholder="Họ và tên đầy đủ" required></div>
          <div class="field"><label for="su-username">Tài khoản đăng nhập</label>
            <input id="su-username" name="username" type="text" placeholder="Ví dụ: nguyenvana" required></div>
          <div class="field"><label for="su-unit">Đơn vị</label>
            <input id="su-unit" name="unit" type="text" placeholder="Ví dụ: Phòng Chính trị..." required></div>
          <div class="field"><label for="su-password">Mật khẩu</label>
            <input id="su-password" name="password" type="password" placeholder="Tạo mật khẩu (≥ 6 ký tự)" required minlength="6"></div>
          <div class="field"><label for="su-password2">Nhập lại mật khẩu</label>
            <input id="su-password2" name="password2" type="password" placeholder="Nhập lại mật khẩu" required minlength="6"></div>
          <div class="field" style="display:flex;justify-content:flex-end">
            <button type="submit" class="btn">Tạo tài khoản</button>
          </div>
          <div id="signup-error" class="error" style="display:none"></div>
        </form>
      </aside>
    </section>
  </main>

  <footer class="site-footer">PTKV3 • Trung tâm Giáo dục Chính trị Số © 2025</footer>

  <script>
    // Chuyển tab
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        const target=btn.getAttribute('data-target');
        document.querySelectorAll('.pane').forEach(p=>p.style.display='none');
        document.getElementById(target).style.display='block';
      });
    });

    /* API của anh – giữ nguyên */
    const API_BASE='https://script.google.com/macros/s/AKfycbzEHcyyvrGEHGt9QSaGMu0sXPBQbJ5sIHk_MNc0t1sY7oExeWPm8rBNXDfIAaGxwvkkKQ/exec';
    async function apiPost(action,payload){
      const res=await fetch(API_BASE+'?action='+encodeURIComponent(action),{
        method:'POST',headers:{'Content-Type':'text/plain; charset=utf-8'},
        body:JSON.stringify(payload||{})
      });
      const txt=await res.text(); try{return JSON.parse(txt)}catch{return{ok:false,error:'Phản hồi máy chủ không hợp lệ',_raw:txt}};
    }
    document.getElementById('login-pane').addEventListener('submit',async(e)=>{
      e.preventDefault();
      const u=document.getElementById('li-username').value.trim();
      const p=document.getElementById('li-password').value;
      const r=await apiPost('login',{username:u,password:p});
     if(r && r.ok){
    localStorage.setItem('ctct_token', r.token);
    localStorage.setItem('ctct_user', JSON.stringify(r.user || {}));
    localStorage.setItem('ptkv3_token', r.token);
    localStorage.setItem('ptkv3_user', JSON.stringify(r.user || {}));

  // ==== NEW: lưu session cho trang làm bài ====
      try{
        const u = r.user || {};
        sessionStorage.setItem('ptkv3:auth', JSON.stringify({
          userId:   u.userId || u.id || '',
          username: u.username || u.account || u.email || '',
          fullName: u.fullName || u.name || '',
          unit:     u.unit || ''
        }));
      }catch(e){ console.warn('set session auth fail', e); }

      const back = new URLSearchParams(location.search).get('redirect') || 'index.html';
      location.replace(back);
    }else{
        const el=document.getElementById('login-error');el.textContent=(r&&r.error)?r.error:'Không thể đăng nhập.';el.style.display='block';
      }
    });
    document.getElementById('signup-pane').addEventListener('submit',async(e)=>{
      e.preventDefault();
      const name=document.getElementById('su-name').value.trim();
      const username=document.getElementById('su-username').value.trim();
      const unit=document.getElementById('su-unit').value.trim();
      const pw=document.getElementById('su-password').value;
      const pw2=document.getElementById('su-password2').value;
      const err=t=>{const el=document.getElementById('signup-error');el.textContent=t;el.style.display='block';};
      if(!name) return err('Vui lòng nhập họ tên.');
      if(!username) return err('Vui lòng nhập tài khoản đăng nhập.');
      if(!unit) return err('Vui lòng nhập đơn vị.');
      if(!pw||pw.length<6) return err('Mật khẩu phải ít nhất 6 ký tự.');
      if(pw!==pw2) return err('Mật khẩu nhập lại không khớp.');
      const r2=await apiPost('register',{name,username,unit,password:pw});
      if(r2&&r2.ok){
        alert('Tạo tài khoản thành công. Vui lòng đăng nhập.');
        document.querySelector('.tab[data-target="login-pane"]').click();
      }else{
        err((r2&&r2.error)?r2.error:'Không thể đăng ký.');
      }
    });
    document.getElementById('forgot-link')?.addEventListener('click',e=>{
      e.preventDefault(); alert('Vui lòng liên hệ quản trị hoặc dùng chức năng khôi phục ở backend.');
    });
    function onLoginSuccess(token){
      localStorage.setItem('ctct_token',token);
      const p=new URLSearchParams(location.search);
      const back=p.get('redirect')||'index.html';
      location.replace(back);
    }
  </script>
</body>
</html>
