<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PTKV3 ‚Ä¢ H·ªçc t·∫≠p AI chuy√™n bi·ªát</title>

<link rel="stylesheet" href="css/nav.css?v=20251006">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#A41919; --accent:#FFD966; --bg:#FFF8ED; --text:#0f172a;
  --muted:#6b7280; --border:#e5e7eb; --radius:14px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
a{color:inherit;text-decoration:none} a:hover{color:#dc2626}

/* ===== Header/ Footer ƒë·ªìng b·ªô Tintuc24 ===== */
.header{position:sticky;top:0;z-index:50;font-weight:600;background:linear-gradient(90deg,#7f1d1d,#b91c1c 45%,#dc2626);color:#fff}
.nav{max-width:1200px;margin:auto;display:flex;gap:18px;align-items:center;padding:12px 16px}
.nav .brand{font-weight:800}
.nav a{color:#fff;padding:6px 10px;border-radius:8px}
.nav a[aria-current="page"]{background:rgba(0,0,0,.18)}
.nav a:hover{color:var(--accent); transform:scale(1.04)}
.footer{margin-top:40px;background:#111827;color:#cbd5e1}
.footer .wrap{max-width:1200px;margin:auto;padding:20px 16px;font-size:14px}

/* ===== Page ===== */
.container{max-width:1200px;margin:0 auto;padding:16px}
.page-title{font-size:32px;font-weight:800;margin:22px 0 10px}
.section{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px}
.search-row{display:flex;gap:12px;align-items:center}
.search-row input{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:999px;background:#fff}

.grid{display:grid;gap:16px}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:980px){.grid-3{grid-template-columns:1fr}}

.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px}
.mat-card:hover{transform:translateY(-4px);box-shadow:0 6px 16px rgba(0,0,0,.10)}

/* --- Google-Drive like cards --- */
.grid-drive{
  display:grid; gap:16px;
  grid-template-columns:repeat(4,minmax(0,1fr));
}
@media(max-width:1200px){ .grid-drive{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
@media(max-width:900px) { .grid-drive{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
@media(max-width:560px) { .grid-drive{ grid-template-columns:1fr; } }

/* m·ªói card */
.drive-card{
  border:1px solid var(--border);
  border-radius:12px;
  background:#adb5d3;
  overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
  transition:.2s transform,.2s box-shadow;
  cursor:pointer;
}
.drive-card:hover{ transform:translateY(-3px); box-shadow:0 10px 18px rgba(0,0,0,.10); }

/* ===== Thanh ti√™u ƒë·ªÅ ===== */
.drive-head{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px;
  background:#fff;            /* li·ªÅn v·ªõi card, kh√¥ng c√≥ v·∫°ch ngƒÉn */
  border-bottom:none;         /* b·ªè k·∫ª tr·∫Øng */
}
.drive-head .mime{
  width:20px; height:20px;              /* vu√¥ng nh·ªè nh∆∞ ·∫£nh */
  background:#ef4444; color:#fff;
  font-weight:600; font-size:8px;
  display:flex; align-items:center; justify-content:center;
  border-radius:4px; flex-shrink:0;
}
.drive-title{
  font-weight:800; color:#111; flex:1; min-width:0;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* ===== Khung preview ·∫£nh (nh∆∞ ·∫£nh m·∫´u) ===== */
.drive-body{ padding:8px; background:#fff; }         /* t·∫°o kho·∫£ng c√°ch khung v·ªõi vi·ªÅn card */
.drive-frame{
  width:100%;
  aspect-ratio:16/9;                                  /* gi·ªëng thumbnail Drive; ƒë·ªïi 4/3 n·∫øu c·∫ßn */
  background:#f3f4f6;                                 /* n·ªÅn x√°m nh·∫°t d∆∞·ªõi ·∫£nh */
  border:1px solid #e5e7eb;                           /* vi·ªÅn khung m·∫£nh */
  border-radius:4px;                                 /* bo g√≥c khung */
  overflow:hidden;                                    /* ·∫£nh tr√†n k√≠n */
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.6);    /* vi·ªÅn s√°ng r·∫•t nh·∫π nh∆∞ ·∫£nh m·∫´u */
}
.drive-frame img{
  width:100%; height:100%;
  object-fit:cover; display:block; border:none;
}
/* ·∫®n/hi·ªán search section khi v√†o xem t√†i li·ªáu */
.section.is-hidden{ display:none !important; }

.gd-footer{display:flex;justify-content:space-between;align-items:center;padding:8px 12px}
.gd-badge{border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px;color:#374151;background:#fff}
.gd-pill{background:#facc15;color:#111;border:none;border-radius:8px;padding:6px 10px;font-weight:700}
.title{
  margin-top:8px;font-weight:800;line-height:1.3;
  display:-webkit-box;-webkit-box-orient:vertical;
  -webkit-line-clamp:3;    /* ‚Üë webkit */
  line-clamp:3;            /* ‚Üë thu·ªôc t√≠nh chu·∫©n (th√™m ƒë·ªÉ t∆∞∆°ng th√≠ch) */
  overflow:hidden;min-height:4.8em;
}
.meta{display:flex;gap:8px;align-items:center;margin-top:6px}
.badge{border:1px solid #d1d5db;border-radius:999px;font-size:12px;padding:3px 9px;background:#fff;color:#374151}
.btn{padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,#A41919,#C62828);color:#fff;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid var(--border);color:#111}

/* Viewer split */
.split{display:grid;grid-template-columns:1.35fr .65fr;gap:16px}
@media(max-width:1024px){.split{grid-template-columns:1fr}}
.viewer iframe{width:100%;height:72vh;border:0;border-radius:12px;background:#000}

/* AI chat box */
.ai-dock{
  display:flex; flex-direction:column;
  border:1px solid #ffe08a; border-radius:14px; overflow:hidden; background:#fff;
  box-shadow:0 6px 18px rgba(0,0,0,.06);
}
.ai-dock .head{
  height:52px; font-weight: 600;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 14px;
  background:linear-gradient(180deg,#ffe470 0%,#facc15 100%);
  border-bottom:1px solid #ffe08a;
}

/* ·∫®n c√°c n√∫t control */
.ai-dock .head .btn{ display:none; }
.ai-dock .body{
  flex:1; min-height:260px; max-height:56vh;
  overflow:auto; padding:14px;
  background:#fff;
}
.bubble{ 
  padding:10px 12px; border-radius:12px; margin:8px 0; 
  max-width:90%; line-height:1.55; box-shadow:0 1px 2px rgba(0,0,0,.04);
}
.bubble.user{ background:#e8f0ff; margin-left:auto; }
.bubble.ai{ background:#fff8db; }
.bubble small{ display:block; margin-top:4px; color:#6b7280; }
/* Composer (input) d√≠nh ƒë√°y, ki·ªÉu app chat hi·ªán ƒë·∫°i */
.ai-dock .input{
  position:sticky; bottom:0; z-index:1;
  background:#fff; padding:12px 12px; 
  border-top:1px solid #ffe08a;
  display:flex; gap:10px; align-items:center;
}
.ai-dock .input input{
  flex:1; height:46px; border-radius:9999px; font-size:15px;
  padding:0 16px;
  border:1px solid #e5e7eb; outline:none;
  box-shadow:inset 0 1px 0 rgba(0,0,0,.02);
}
.ai-dock .input input:focus{
  border-color:#f59e0b; box-shadow:0 0 0 3px rgba(245,158,11,.2);
}

.ai-dock .btn{ background:#f59e0b; color:#000; border:none; border-radius:9999px; padding:8px 14px; font-weight:700; cursor:pointer; }

/* N√∫t ‚ÄúG·ª≠i‚Äù ‚Äì pill g·ªçn, c√≥ icon g·ª≠i */
.ai-dock .btn#aiSend{
  height:46px; min-width:52px; padding:0 18px;
  border-radius:12px; border:none; cursor:pointer;
  background:linear-gradient(180deg,#ffb13b,#f59e0b);
  color:#111; font-weight:600; letter-spacing:.2px;
  box-shadow:0 2px 0 rgba(0,0,0,.06), 0 8px 16px rgba(245,158,11,.18);
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  transition:transform .12s ease, filter .12s ease;
}
.ai-dock .btn#aiSend::before{
  font-size:14px; transform:rotate(45deg);
}
.ai-dock .btn#aiSend:hover{ filter:brightness(.98); transform:translateY(-1px); }
.ai-dock .btn#aiSend:active{ transform:translateY(0); }

/* Quiz tu·∫ßn t·ª± */
.quiz .q{margin:8px 0 4px;font-weight:700}
.quiz ul{padding-left:0;margin:8px 0}
.quiz li{list-style:none;margin:6px 0;padding:8px;border:1px solid var(--border);border-radius:10px;display:flex;gap:8px;align-items:center}
.quiz .nav{display:flex;gap:8px;margin-top:8px}
.result-card{background:#ecfdf5;border:1px solid #bbf7d0;border-radius:12px;padding:12px;margin-top:8px}

.spinner{width:34px;height:34px;border:3px solid #ddd;border-top-color:#A41919;border-radius:50%;animation:spin 1s linear infinite;margin:16px auto}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{padding:24px;border:1px dashed #ddd;border-radius:14px;text-align:center;color:#6b7280}

/* N√∫t ‚ÄúQuay l·∫°i H·ªçc t·∫≠p‚Äù d·∫°ng pill chuy√™n nghi·ªáp */
.btn.back{
  display:inline-flex;               /* gi·ªØ chi·ªÅu ngang theo n·ªôi dung */
  align-items:center; justify-content:center;
  gap:8px;
  background:#f2760a;
  color:#fbfbfb;
  border:2px solid #f7fb00;
  border-radius:9999px;
  padding:10px 18px;
  font-weight:700;
  font-size: 14px;
  white-space:nowrap; 
  height:auto; min-height:42px;      /* ngƒÉn cao = r·ªông */
  width:auto; max-width:100%;
  box-shadow:0 2px 0 rgba(244, 3, 3, 0.12);
}
.btn.back:hover{
  filter:brightness(0.98);
  transform:translateY(-1px);
}
.btn.back:active{ transform:translateY(0); }
@media (max-width:420px){
  .btn.back{
    white-space:normal;              /* cho ph√©p xu·ªëng d√≤ng khi c·∫ßn */
    border-radius:12px;              /* bo g√≥c v·ª´a ph·∫£i ‚áí kh√¥ng th·ªÉ tr√≤n */
    padding:10px 14px;
  }
}
/* Viewer: iframe cao t·ªëi thi·ªÉu 72vh, JS s·∫Ω ƒë·ªìng b·ªô >= chi·ªÅu cao c·ªôt ph·∫£i */
.viewer iframe{
  width:100%;
  min-height:72vh;
  border:0;
  border-radius:12px;
  background:#000;}

  /* B·ªè box quanh khu t√¨m ki·∫øm */
#searchBar.section{
  background: transparent;
  border: 0;
  padding: 0;
  margin: 8px 0 18px;
}

/* H√†ng t√¨m ki·∫øm ki·ªÉu pill hi·ªán ƒë·∫°i */
.search-row{
  position: relative;
  display: flex;
  align-items: center;
  gap: 0;                 /* input + n√∫t li·ªÅn kh·ªëi */
}

.search-row input{
  flex: 1;
  height: 54px;
  padding: 0 56px 0 52px;                       /* ch·ª´a ch·ªó icon + n√∫t */
  border: 1px solid #e5e7eb;
  border-radius: 9999px;
  background: #fff;
  font-size: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,.04) inset, 0 2px 8px rgba(0,0,0,.04);
  outline: none;
}
.search-row input:focus{
  border-color: #f59e0b;
  box-shadow: 0 0 0 4px rgba(245,158,11,.18);
}

/* Icon k√≠nh l√∫p n·∫±m trong input (kh√¥ng c·∫ßn ƒë·ªïi HTML) */
.search-row::before{
  content: "üîé";
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  opacity: .6;
  pointer-events: none;
}

/* N√∫t T√¨m g·∫Øn li·ªÅn v√†o b√™n ph·∫£i input */
#btnFind{
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);
  width: 70px;
  height: 42px;
  padding: 0 18px;
  border: none;
  border-radius: 9999px;
  font-weight: 600;
  background: linear-gradient(90deg,#a41919,#c62828);
  color: #fff;
  cursor: pointer;
  box-shadow: 0 2px 0 rgba(0,0,0,.08), 0 10px 18px rgba(164,25,25,.18);
  transition: transform .12s ease, filter .12s ease;
}

/* Mobile tinh ch·ªânh m·ªôt ch√∫t */
@media (max-width: 640px){
  .search-row input{ height: 50px; padding: 0 54px 0 48px; }
  #btnFind{ height: 40px; padding: 0 16px; }
}
.m-toggle{
  display:none !important;
  background:transparent; border:0; color:#fff;
  font-size:28px; line-height:1;
}
/* Mobile styles */
@media (max-width:1024px){
  .nav a:not(.brand), .nav .has-dropdown{display:none !important;}
  .m-toggle{display:block !important; margin-left:auto;}

  .m-drawer{
    position:fixed; inset:0 auto 0 0; width:86vw; max-width:420px;
    transform:translateX(-100%);
    background:linear-gradient(180deg,#7f1d1d,#b91c1c 55%,#9d1414);
    color:#fff; z-index:120; transition:transform .25s ease;
    box-shadow:4px 0 30px rgba(0,0,0,.25);
  }
  .m-head{display:flex; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.12)}
  .m-home{font-size:22px; text-decoration:none}
  .m-brand{font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .m-close{margin-left:auto; background:0 0; border:0; color:#fff; font-size:28px; cursor:pointer}

  .m-menu{padding:8px 8px 18px}
  .m-item{display:block; color:#fff; padding:14px 10px; font-weight:600; border-bottom:1px solid rgba(255,255,255,.08)}
  .m-sub{display:flex; flex-direction:column; gap:6px; padding:10px 10px 12px}
  .m-sub[hidden]{display:none !important;}
  .m-drop .caret{float:right}
  .m-drop[aria-expanded="true"] .caret{ transform: rotate(180deg); }

  .m-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(2px);
    z-index:110; opacity:0; transition:opacity .25s; pointer-events:none;
  }

  /* States */
  body.menu-open .m-drawer{transform:translateX(0)}
  body.menu-open .m-backdrop{opacity:1; pointer-events:auto}
  body.no-scroll{overflow:hidden}

  /* Link ƒëang ·ªü trang hi·ªán t·∫°i trong drawer */
  .m-menu .m-item[aria-current="page"]{
    background: rgba(255,255,255,.16);
    border-left: 3px solid #FFD966;
    font-weight: 800;
  }
}
/* ===== Mobile: Back l√™n g√≥c tr√°i, ti√™u ƒë·ªÅ xu·ªëng d∆∞·ªõi & full-width ===== */
@media (max-width: 768px){
  /* Khung flex ch·ª©a H2 v√† n√∫t Back (ƒë√∫ng nh∆∞ HTML hi·ªán t·∫°i) */
  .card > div > div[style*="display:flex"]{
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 10px !important;
  }

  /* N√∫t "Quay l·∫°i chuy√™n ƒë·ªÅ" l√™n tr∆∞·ªõc, b√°m tr√°i */
  .card > div > div[style*="display:flex"] > #back{
    order: -1;
    align-self: flex-start;
    margin: 2px 0 2px;
  }

  /* Ti√™u ƒë·ªÅ n·∫±m d∆∞·ªõi v√† gi√£n full chi·ªÅu ngang */
  .card > div > div[style*="display:flex"] h2{
    order: 2;
    margin: 0 !important;
    width: 100%;
    text-align: left;
    font-size: 20px;         /* c√≥ th·ªÉ 22px n·∫øu mu·ªën n·ªïi h∆°n */
    line-height: 1.32;
    text-wrap: balance;
  }

  /* Ch·ªëng n√∫t b·ªã tr√≤n & qu√° to tr√™n mobile */
  .btn.back{
    border-radius: 12px !important;   /* pill nh·∫π, kh√¥ng tr√≤n xoe */
    padding: 8px 12px !important;
    min-height: 40px !important;
    height: auto !important;
    width: auto !important;
    white-space: nowrap !important;    /* gi·ªØ 1 d√≤ng g·ªçn g√†ng */
  }
}

/* H√†ng ti√™u ƒë·ªÅ d√πng chung (th√™m class .mat-bar cho khung flex hi·ªán t·∫°i) */
.mat-bar{ display:flex; align-items:center; gap:10px; justify-content:space-between; }

/* Wrapper cho n√∫t back khi t√°ch ra ngo√†i (·∫©n tr√™n desktop) */
.btn-back-wrapper{ display:none; }

@media (max-width:768px){
  /* Hi·ªán wrapper v√† ƒë·∫∑t kho·∫£ng c√°ch tr√™n d∆∞·ªõi */
  .btn-back-wrapper{
    display:flex;
    justify-content:flex-start;
    margin:8px 0 10px;
  }

  /* T·ªëi ∆∞u n√∫t back khi t√°ch ra ngo√†i ‚Äì g·ªçn, kh√¥ng ‚Äútr√≤n xoe‚Äù */
  .btn-back-wrapper .btn.back{
    padding:8px 14px !important;
    border-radius:12px !important;
    white-space:nowrap !important;
    min-height:40px;
  }

  /* Khi ·ªü mobile: ti√™u ƒë·ªÅ trong khung ·ªü d∆∞·ªõi v√† full-width */
  .mat-bar{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }
  .mat-bar h2{
    margin:0 !important;
    width:100%;
    text-align:left;
    font-size:20px;
    line-height:1.32;
    text-wrap:balance;
  }
}
/* Lu√¥n 1 d√≤ng cho ti√™u ƒë·ªÅ trang */
.page-title{
  font-size: clamp(22px, 4.6vw, 32px);
  font-weight: 800;
  line-height: 1.5;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin: 10px 0 10px;
  text-rendering: optimizeLegibility; 
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* N·∫øu mu·ªën kh√¥ng b·ªã ‚Äú‚Ä¶‚Äù ·ªü m√°y c·ª±c nh·ªè, c√≥ th·ªÉ n√©n ch·ªØ th√™m ch√∫t */
@media (max-width: 360px){
  .page-title{
    font-size: clamp(18px, 5vw, 26px);
    letter-spacing: .2px;
  }
}

</style>

<script>
// ===== C·∫§U H√åNH API (ƒë·ªïi sang URL Apps Script c·ªßa anh) =====
window.PTKV3_API = 'https://script.google.com/macros/s/AKfycbzqMdQxvITlXYnjDSyEsvlEqxHKbOQ0y3ldQMsz04pHOJ4itsf-s3gNQhkj6i5YYfe2/exec';
</script>
</head>
<body>

 
<!-- ===== HEADER (ƒë·ªìng b·ªô Tintuc24) ===== -->
<header class="header">
  <nav class="nav" role="navigation" aria-label="ƒêi·ªÅu h∆∞·ªõng ch√≠nh">
    <a class="brand" href="index.html">BAN CH·ªà HUY PTKV3</a>
    <a href="index.html">Trang ch·ªß</a>
    <a href="tintuc24.html">Tin t·ª©c</a>
    <a href="Hoctap.html" aria-current="page">H·ªçc t·∫≠p</a>
    <a href="kiemtra.html">Ki·ªÉm tra</a>

    <div class="nav__item has-dropdown">
      <a href="#" aria-haspopup="true" aria-expanded="false">K·∫øt qu·∫£ ki·ªÉm tra ‚ñæ</a>
      <div class="dropdown" role="menu" aria-label="K·∫øt qu·∫£ ki·ªÉm tra">
        <a href="my-results.html" role="menuitem">K·∫øt qu·∫£ c·ªßa t√¥i</a>
        <a href="leaderboard.html" role="menuitem">B·∫£ng x·∫øp h·∫°ng</a>
      </div>
    </div>

    <div class="sp"></div>
    <button class="m-toggle" aria-label="M·ªü menu">‚ò∞</button>
  </nav>
</header>
<!-- ===== MOBILE DRAWER ===== -->
<aside id="mDrawer" class="m-drawer" aria-hidden="true" role="dialog" aria-label="Menu">
  <div class="m-head">
    <a class="m-home" href="index.html" aria-label="Trang ch·ªß" title="Trang ch·ªß">üè†</a>
    <span class="m-brand">BAN CH·ªà HUY PTKV3</span>
    <button class="m-close" aria-label="ƒê√≥ng menu">‚úï</button>
  </div>

  <nav class="m-menu" role="navigation" aria-label="Menu di ƒë·ªông">
    <a class="m-item" href="index.html">Trang ch·ªß</a>
    <a class="m-item" href="tintuc24.html">Tin t·ª©c</a>
    <a class="m-item" href="Hoctap.html" aria-current="page">H·ªçc t·∫≠p</a>
    <a class="m-item" href="kiemtra.html">Ki·ªÉm tra</a>

    <button class="m-item m-drop"
            data-target="#m-result"
            aria-controls="m-result"
            aria-expanded="false">
      K·∫øt qu·∫£ ki·ªÉm tra <span class="caret">‚ñæ</span>
    </button>
    <div id="m-result" class="m-sub" hidden>
      <a href="my-results.html">K·∫øt qu·∫£ c·ªßa t√¥i</a>
      <a href="leaderboard.html">B·∫£ng x·∫øp h·∫°ng</a>
    </div>
  </nav>
</aside>
<div class="m-backdrop" hidden></div>

<div class="container">
  <h1 class="page-title">H·ªåC T·∫¨P CHUY√äN ƒê·ªÄ</h1>

  <section id="searchBar" class="section">
    <div class="search-row">
      <input id="kw" placeholder="T√¨m t√†i li·ªáu theo t√™n, chuy√™n ƒë·ªÅ...">
      <button class="btn" id="btnFind" type="button">T√¨m</button>
    </div>
  </section>

  <section id="materials-list"></section>
</div>

<!-- ===== FOOTER (ƒë·ªìng b·ªô Tintuc24) ===== -->
<footer class="footer">
  <div class="wrap">
    <strong>PTKV3 ‚Ä¢ Trung t√¢m Gi√°o d·ª•c Ch√≠nh tr·ªã s·ªë ¬© 2025</strong>
  </div>
</footer>

<script>
/* ===== Core fetch ===== */
async function apiCall(action, payload = {}) {
  if (!window.PTKV3_API) throw new Error('Ch∆∞a c·∫•u h√¨nh PTKV3_API');
  const u = new URL(window.PTKV3_API);
  const qs = JSON.stringify(payload);
  u.searchParams.set('action', action);
  u.searchParams.set('payload', qs);
  if (u.toString().length > 1800) {
    const res = await fetch(window.PTKV3_API, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
      body: JSON.stringify({ action, payload })
    });
    const data = await res.json(); if (!data.ok) throw new Error(data.error||'API error'); return data.data||{};
  }
  const res = await fetch(u.toString(), { method: 'GET' });
  const data = await res.json(); if (!data.ok) throw new Error(data.error||'API error'); return data.data||{};
}
const el=(t,a={},c=[])=>{const e=document.createElement(t);Object.entries(a).forEach(([k,v])=>{if(k==='class')e.className=v;else if(k==='html')e.innerHTML=v;else e.setAttribute(k,v)});(Array.isArray(c)?c:[c]).filter(Boolean).forEach(ch=>e.append(ch));return e;}
const spinner=()=>{const d=document.createElement('div');d.className='spinner';return d;}
const showEmpty=(t,m)=>{t.innerHTML='';t.append(el('div',{class:'empty'},m));}

/* ===== Helpers ===== */
async function quizHasQuestions(fileId){
  try{ const d = await apiCall('quiz.has',{fileId}); return !!(d && d.count>0); }catch(_){return false;}
}
async function loadSections(fileId){
  try{ const d = await apiCall('materials.sections',{fileId}); return d.items||[]; }catch(_){return [];}
}
function cleanTitle(s=''){
  return String(s).replace(/\.(pdf|docx?|pptx?|xlsx?)$/i,'');
}
// L·∫•y ·∫£nh xem tr∆∞·ªõc t·ª´ Drive d√π kh√¥ng c√≥ thumbnail trong Sheets
function driveThumb(fileId){
  // sz=w900 cho ·∫£nh ƒë·ªß n√©t; Google t·ª± crop & cache
  return `https://drive.google.com/thumbnail?id=${encodeURIComponent(fileId)}&sz=w900`;
}

function toggleSearch(show){
  const s = document.getElementById('searchBar');
  if (s) s.style.display = show ? '' : 'none';
}
const STORAGE = {
  CURRENT: 'ptkv3.currentMaterial',       // {fileId, 'tieu-de': ...}
  CHAT_PREFIX: 'ptkv3.chat.'              // CHAT_PREFIX + fileId => [{who, html}]
};

/* ===== Page: list ===== */
const $list = document.getElementById('materials-list');
document.getElementById('btnFind').addEventListener('click', ()=> searchAndMount($list, document.getElementById('kw').value));
document.getElementById('kw').addEventListener('keydown', e=>{ if(e.key==='Enter') searchAndMount($list, e.target.value); });

async function searchAndMount(container, keyword=''){ await mountMaterials(container, keyword); }

async function mountMaterials(container, keyword=''){
  container.innerHTML=''; container.append(spinner());
  try{
    const data = await apiCall('tailieu.danh-sach', {'tu-khoa': keyword});
    container.innerHTML='';
    const gridWrap = el('div',{class:'grid-drive'});
    // Ki·ªÉm tra quiz cho t·ª´ng t√†i li·ªáu (ƒë·ªÉ ·∫©n n√∫t ngo√†i)
    const items = data.items || [];
    // Load song song hasQuiz:
    const flags = await Promise.all(items.map(m=>quizHasQuestions(m.fileId)));

    items.forEach((m, idx)=>{
      const hasQuiz = !!flags[idx];
      const titleClean = String(m['tieu-de']||'').replace(/\.pdf$/i,'');
      const card = el('div',{class:'drive-card'});
      card.style.cursor = 'pointer';
      card.setAttribute('tabindex','0'); // h·ªó tr·ª£ Enter/Space

      // Header: [chip PDF] [ti√™u ƒë·ªÅ 1 d√≤ng ‚Ä¶] [kebab]
      const head = el('div',{class:'drive-head'});
      head.append(el('span',{class:'mime'},'PDF'));
      head.append(el('div',{class:'drive-title'}, titleClean));
      head.append(el('span',{style:'opacity:.4'},'‚ãÆ'));
      card.append(head);

      // Thumbnail trong KHUNG (·∫£nh tr√†n k√≠n khung)
      const thumbSrc = (m.thumbnail && m.thumbnail.trim()) ? m.thumbnail : driveThumb(m.fileId);
      const body  = el('div',{class:'drive-body'});
      const frame = el('div',{class:'drive-frame'});              // khung ch·ª©a ·∫£nh
      frame.append(el('img',{src:thumbSrc, alt:titleClean}));     // ·∫£nh tr√†n khung
      body.append(frame);
      card.append(body);

      if (m['chu-de']) {
        const meta = el('div',{style:'padding:0 12px 12px'});
        meta.append(el('span',{class:'badge'}, m['chu-de']));
        card.append(meta);
      }

      // Ch·ªâ hi·ªán ‚Äú√în t·∫≠p‚Äù n·∫øu CH∆ØA c√≥ c√¢u h·ªèi trong Sheets
      if (!hasQuiz){
        const act = el('div',{style:'padding:0 12px 12px;display:flex;justify-content:flex-start'});
        const btn = el('button',{class:'btn',type:'button',style:'background:#facc15;color:#111;font-weight:700;border:none'},'√în t·∫≠p');
        btn.onclick = (e)=>{ e.stopPropagation(); mountQuizOnly(container,m); };
        act.append(btn); card.append(act);
      }

      card.addEventListener('click', ()=> mountMaterialView(container, m));

      gridWrap.append(card);        // <-- append v√†o gridWrap
    });

    if(!gridWrap.children.length){ showEmpty(container,'Ch∆∞a c√≥ t√†i li·ªáu.'); return; }
    container.append(gridWrap);
    toggleSearch(true);
  }catch(e){
    showEmpty(container,'L·ªói t·∫£i d·ªØ li·ªáu: '+ (e && e.message ? e.message : e));
  }
}

function openAIDock(fileMeta, targetEl, opts = { reset: false }){
  const mountAt = targetEl 
    || document.querySelector('.split .grid') 
    || document.querySelector('.grid') 
    || document.body;

  // Lu√¥n remove dock c≈© ƒë·ªÉ render s·∫°ch
  const oldDock = document.querySelector('.ai-dock');
  if (oldDock) oldDock.remove();

  // Reset chat khi m·ªü t√†i li·ªáu m·ªõi (kh√¥ng reset khi F5)
  const chatKey = STORAGE.CHAT_PREFIX + fileMeta.fileId;
  if (opts.reset) sessionStorage.removeItem(chatKey);

  // T·∫°o dock m·ªõi
  const dock = document.createElement('div');
  dock.className = 'ai-dock';
  dock.innerHTML = `
    <div class="head">
      <span>Tr√≤ chuy·ªán v·ªõi AI</span>
      <div style="display:flex;gap:6px">
        <button id="aiMin" class="btn" aria-hidden="true">‚àí</button>
        <button id="aiClose" class="btn" aria-hidden="true">√ó</button>
      </div>
    </div>
    <div class="body" id="aiBody"></div>
    <div class="input">
      <input id="aiInput" placeholder="Nh·∫≠p c√¢u h·ªèi..." />
      <button id="aiSend" class="btn">G·ª≠i</button>
    </div>
  `;
  mountAt.prepend(dock);

  const box = dock.querySelector('#aiBody');
  const inp = dock.querySelector('#aiInput');
  const btn = dock.querySelector('#aiSend');

  // helpers
  const esc = s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const add = (who, html)=>{
    const div = document.createElement('div');
    div.className = 'bubble ' + (who==='user' ? 'user' : 'ai');
    div.innerHTML = html;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  };
  const saveChat = ()=>{
    // l∆∞u to√†n b·ªô bubbles (nh·∫π nh√†ng) v√†o sessionStorage
    const nodes = [...box.querySelectorAll('.bubble')].map(n=>{
      return { who: n.classList.contains('user')?'user':'ai', html: n.innerHTML };
    });
    sessionStorage.setItem(chatKey, JSON.stringify(nodes));
  };
  const restoreChat = ()=>{
    const raw = sessionStorage.getItem(chatKey);
    box.innerHTML = '';
    if (!raw){
      add('ai','Ch√†o b·∫°n! M√¨nh c√≥ th·ªÉ gi√∫p g√¨ ƒë∆∞·ª£c cho b·∫°n?');
      return;
    }
    try{
      const arr = JSON.parse(raw);
      arr.forEach(m=>add(m.who, m.html));
    }catch{
      add('ai', 'Xin ch√†o! Em l√† Tr·ª£ l√Ω h·ªçc t·∫≠p AI c·ªßa PTKV3 üåü. Anh/ch·ªã mu·ªën em gi√∫p g√¨ trong t√†i li·ªáu n√†y ·∫°?');
    }
  };

  const ask = async ()=>{
    const q = inp.value.trim(); if(!q) return;
    add('user', esc(q)); inp.value='';
    saveChat();
    const wait = document.createElement('div'); wait.className='bubble ai'; wait.textContent='ƒêang suy nghƒ©...'; box.append(wait);

    try{
      const r = await apiCall('ai.chat',{ fileId:fileMeta.fileId, section:'', 'cau-hoi': q });
      const src = r.source ? `<small>üìö Ngu·ªìn: ${esc(r.source)}</small>` : '';
      wait.innerHTML = (r.answer || '(kh√¥ng c√≥ ph·∫£n h·ªìi)').replace(/\n/g,'<br>') + src;
    }catch(e){
      wait.innerHTML = '<b>L·ªói:</b> ' + esc(e.message||e);
    }
    saveChat();
    box.scrollTop = box.scrollHeight;
  };

  inp.onkeydown = (e)=>{ if(e.key==='Enter'){ e.preventDefault(); ask(); } };
  btn.onclick = ask;

  // Kh√¥i ph·ª•c khi F5, ho·∫∑c greeting m·ªõi khi m·ªü l·∫ßn ƒë·∫ßu
  restoreChat();
}


/* ===== Material view (viewer + AI + C√¢u h·ªèi √¥n t·∫≠p) ===== */
async function mountMaterialView(root, meta){
  root.innerHTML='';
  const searchSection = document.getElementById('searchBar');
  if (searchSection) searchSection.classList.add('is-hidden');

  // l∆∞u tr·∫°ng th√°i ƒëang xem (ƒë·ªÉ F5 kh√¥i ph·ª•c)
  localStorage.setItem(STORAGE.CURRENT, JSON.stringify({fileId: meta.fileId, 'tieu-de': meta['tieu-de']||'T√†i li·ªáu'}));

  const backToList = ()=>{
    if(searchSection) searchSection.classList.remove('is-hidden');
    localStorage.removeItem(STORAGE.CURRENT); // b·∫•m quay l·∫°i th√¨ th√¥i gi·ªØ tr·∫°ng th√°i
    mountMaterials(root);
  };

  // Thanh ti√™u ƒë·ªÅ + n√∫t back (b√™n ph·∫£i)
  const titleClean = cleanTitle(meta['tieu-de']||'T√†i li·ªáu');
  const bar = el('div',{class:'card'});
  bar.append(el('div',{html:`
  <div class="mat-bar" style="display:flex;align-items:center;gap:10px;justify-content:space-between">
    <h2 style="margin:0;font-size:22px;font-weight:800;color:#7f1d1d">${titleClean}</h2>
    <button class="btn back" id="back">Quay l·∫°i Chuy√™n ƒë·ªÅ</button>
  </div>`}));
  bar.querySelector('#back').onclick = backToList;
  root.append(bar);
// === T√ÅCH N√öT BACK RA NGO√ÄI KHUNG (mobile) ‚Äì Desktop gi·ªØ nguy√™n ===
const backBtn = bar.querySelector('#back');
const barRow  = bar.querySelector('.mat-bar');

// T·∫°o wrapper v√† ƒë·∫∑t NGAY TR∆Ø·ªöC kh·ªëi card ti√™u ƒë·ªÅ
const backWrap = document.createElement('div');
backWrap.className = 'btn-back-wrapper';
root.insertBefore(backWrap, bar);

// H√†m b·ªë tr√≠ n√∫t theo k√≠ch th∆∞·ªõc m√†n h√¨nh
const mq = window.matchMedia('(max-width: 768px)');
function placeBack(){
  if (mq.matches) {
    // Mobile: chuy·ªÉn n√∫t ra wrapper (ngo√†i khung)
    if (backBtn && backBtn.parentNode !== backWrap) backWrap.appendChild(backBtn);
  } else {
    // Desktop: ƒë∆∞a n√∫t v·ªÅ l·∫°i trong khung ti√™u ƒë·ªÅ
    if (backBtn && backBtn.parentNode !== barRow) barRow.appendChild(backBtn);
  }
}
placeBack();
// L·∫Øng nghe thay ƒë·ªïi m√†n h√¨nh
if (mq.addEventListener) mq.addEventListener('change', placeBack);
else mq.addListener(placeBack); // fallback cho tr√¨nh duy·ªát c≈©

  const wrap = el('div',{class:'split'});

  // LEFT: Viewer
  const viewer = el('section',{class:'section viewer'});
  const iframe = el('iframe',{src:`https://drive.google.com/file/d/${meta.fileId}/preview`,allow:'autoplay'});
  viewer.append(iframe);
  wrap.append(viewer);

  // RIGHT: AI + Quiz
  const right = el('div',{class:'grid'});

  // Tr√≤ chuy·ªán v·ªõi AI N·∫∞M TRONG TRANG
  openAIDock(meta, right);
  
  // ===== QUIZ: ‚ÄúC√¢u h·ªèi √¥n t·∫≠p‚Äù ki·ªÉu tu·∫ßn t·ª± =====
  const quizBox = el('section',{class:'section quiz'});
  quizBox.append(el('div',{html:'<strong>üß© C√¢u h·ªèi √¥n t·∫≠p</strong>'}));
  const qWrap = el('div'); quizBox.append(qWrap);
  right.append(quizBox);

  wrap.append(right); root.append(wrap);
  
  // H√†m ƒë·ªìng b·ªô chi·ªÅu cao viewer >= c·ªôt ph·∫£i
  const syncViewerHeight = ()=>{
    const hRight = right.offsetHeight;
    const minH = Math.max(hRight, Math.round(window.innerHeight*0.72));
    iframe.style.height = minH + 'px';
  };


  // load quiz (t·ª´ Sheets ‚Äì qu·∫£n tr·ªã ƒë√£ nh·∫≠p s·∫µn)
  try{
    const data = await apiCall('quiz.getByFile',{fileId:meta.fileId,limit:10});
    const items = data.items||[];
    if(!items.length){ qWrap.innerHTML = '<div class="empty">Ch∆∞a c√≥ c√¢u h·ªèi √¥n t·∫≠p cho t√†i li·ªáu n√†y.</div>'; }
    else{
      const state = { idx:0, answers:{} };
      const render = ()=>{
        const it = items[state.idx];
        qWrap.innerHTML = `
          <div class="q">C√¢u ${state.idx+1}/${items.length}. ${it.q}</div>
          <ul>
            ${it.options.map((op,i)=>`
              <li><label><input type="radio" name="q${state.idx}" value="${op}" ${state.answers[state.idx]===op?'checked':''}> ${op}</label></li>
            `).join('')}
          </ul>
          <div class="nav">
            <button class="btn ghost" id="btnPrev" ${state.idx===0?'disabled':''}>Quay l·∫°i</button>
            ${state.idx<items.length-1
              ? '<button class="btn" id="btnNext">Ti·∫øp t·ª•c</button>'
              : '<button class="btn" id="btnFinish">K·∫øt th√∫c</button>'}
          </div>
        `;
        qWrap.querySelectorAll('input[type="radio"]').forEach(r=>{
          r.onchange = ()=>{ state.answers[state.idx]=r.value; };
        });
        const prev=qWrap.querySelector('#btnPrev'), next=qWrap.querySelector('#btnNext'), fin=qWrap.querySelector('#btnFinish');
        if(prev) prev.onclick = ()=>{ state.idx--; render(); };
        if(next) next.onclick = ()=>{ state.idx++; render(); };
        if(fin)  fin.onclick  = ()=> finish();
         syncViewerHeight();
      };
      const finish = ()=>{
        let correct=0; items.forEach((it,i)=>{ if(state.answers[i]===it.answer) correct++; });
        const total=items.length, pct=Math.round(correct*100/total);
        qWrap.innerHTML = `
          <div class="result-card">
            <div style="font-weight:800;font-size:18px;">üéâ Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh n·ªôi dung √¥n t·∫≠p!</div>
            <div style="margin-top:6px">K·∫øt qu·∫£: <strong>${correct}/${total}</strong> (${pct}%).</div>
          </div>`;
          syncViewerHeight();
      };
      render();
    }
  }catch(e){
    qWrap.innerHTML = '<div class="empty">Kh√¥ng t·∫£i ƒë∆∞·ª£c c√¢u h·ªèi: '+e.message+'</div>';
  }
// sync khi resize
  window.addEventListener('resize', syncViewerHeight, {passive:true});
  // sync ban ƒë·∫ßu (sau layout)
  setTimeout(syncViewerHeight, 0);
}
/* ===== Optional: trang √în t·∫≠p ri√™ng (n·∫øu b·∫•m n√∫t ngo√†i) ===== */
async function mountQuizOnly(root, meta){
  root.innerHTML='';
  const nav = el('div',{class:'card', html:`<button class="btn ghost" id="back">&larr; Quay l·∫°i H·ªçc t·∫≠p</button>`});
  nav.querySelector('#back').onclick = ()=> mountMaterials(root);
  root.append(nav);
  root.append(el('div',{class:'card',html:`<h2 style="margin:0">√în t·∫≠p: ${meta['tieu-de']||'T√†i li·ªáu'}</h2>`}));

  const quiz = el('section',{class:'section quiz'}); root.append(quiz);
  const box = el('div',{}); quiz.append(box);

  try{
    const data = await apiCall('quiz.getByFile',{fileId:meta.fileId,limit:10});
    const items = data.items||[];
    if(!items.length){ box.innerHTML = '<div class="empty">Ch∆∞a c√≥ c√¢u h·ªèi.</div>'; return; }

    const state = { idx:0, answers:{} };
    const render = ()=>{
      const it = items[state.idx];
      box.innerHTML = `
        <div class="q">C√¢u ${state.idx+1}/${items.length}. ${it.q}</div>
        <ul>
          ${it.options.map((op,i)=>`
            <li><label><input type="radio" name="qb${state.idx}" value="${op}" ${state.answers[state.idx]===op?'checked':''}> ${op}</label></li>
          `).join('')}
        </ul>
        <div class="nav">
          <button class="btn ghost" id="btnPrev" ${state.idx===0?'disabled':''}>Quay l·∫°i</button>
          ${state.idx<items.length-1
            ? '<button class="btn" id="btnNext">Ti·∫øp t·ª•c</button>'
            : '<button class="btn" id="btnFinish">K·∫øt th√∫c</button>'}
        </div>
      `;
      box.querySelectorAll('input[type="radio"]').forEach(r=>{
        r.onchange = ()=>{ state.answers[state.idx]=r.value; };
      });
      const prev=box.querySelector('#btnPrev'), next=box.querySelector('#btnNext'), fin=box.querySelector('#btnFinish');
      if(prev) prev.onclick = ()=>{ state.idx--; render(); };
      if(next) next.onclick = ()=>{ state.idx++; render(); };
      if(fin)  fin.onclick  = ()=> finish();
    };
    const finish = ()=>{
      let correct=0; items.forEach((it,i)=>{ if(state.answers[i]===it.answer) correct++; });
      const total=items.length, pct=Math.round(correct*100/total);
      box.innerHTML = `
        <div class="result-card">
          <div style="font-weight:800;font-size:18px;">üéâ Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh!</div>
          <div style="margin-top:6px">K·∫øt qu·∫£: <strong>${correct}/${total}</strong> (${pct}%).</div>
        </div>`;
      // c√≥ th·ªÉ l∆∞u k·∫øt qu·∫£ n·∫øu mu·ªën:
      // apiCall('exam.saveResult',{fileId:meta.fileId, title:meta['tieu-de']||'', correct, total, score:pct}).catch(()=>{});
    };
    render();
  }catch(e){ box.innerHTML='<div class="empty">Kh√¥ng t·∫°o ƒë∆∞·ª£c c√¢u h·ªèi: '+e.message+'</div>'; }

  nav.querySelector('#back').onclick = ()=>{ 
    const searchSection = document.querySelector('.container .section');
    if (searchSection) searchSection.classList.remove('is-hidden');
    mountMaterials(root);
  };
}

/* boot */
const saved = localStorage.getItem(STORAGE.CURRENT);
  if (saved){
    // ·ªü l·∫°i trang ƒë·ªçc, kh√¥i ph·ª•c ƒë√∫ng t√†i li·ªáu + AI chat
    const meta = JSON.parse(saved);
    // ƒë·∫£m b·∫£o c√≥ kh√≥a 'tieu-de' ƒë·ªÉ render ti√™u ƒë·ªÅ ƒë·∫πp
    if (!meta['tieu-de']) meta['tieu-de'] = 'T√†i li·ªáu';
    mountMaterialView(document.getElementById('materials-list'), meta);
  }else{
    // kh√¥ng c√≥ tr·∫°ng th√°i -> trang danh s√°ch
    mountMaterials(document.getElementById('materials-list'));}

(function(){
  const drawer   = document.getElementById('mDrawer');
  const backdrop = document.querySelector('.m-backdrop');
  const openBtn  = document.querySelector('.m-toggle');
  const closeBtn = drawer?.querySelector('.m-close');

  const focusables = 'a,button,[tabindex]:not([tabindex="-1"])';
  let lastFocus = null;

  // ‚úÖ ƒê·∫£m b·∫£o panel con lu√¥n ƒë√≥ng m·∫∑c ƒë·ªãnh
  document.querySelectorAll('.m-sub').forEach(p => p.hidden = true);
  document.querySelectorAll('.m-drop').forEach(b => b.setAttribute('aria-expanded','false'));

  function open(){
    lastFocus = document.activeElement;
    document.body.classList.add('menu-open','no-scroll');
    drawer?.setAttribute('aria-hidden','false');
    if (backdrop) backdrop.hidden = false;
    drawer?.querySelector(focusables)?.focus?.();
  }
  function close(){
    document.body.classList.remove('menu-open','no-scroll');
    drawer?.setAttribute('aria-hidden','true');
    if (backdrop) backdrop.hidden = true;
    lastFocus?.focus?.();
  }

  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });

  drawer?.addEventListener('click', e=>{
    const btn = e.target.closest('.m-drop');
    if(!btn) return;
    const id = btn.getAttribute('aria-controls') || btn.dataset.target?.replace('#','');
    const panel = id ? document.getElementById(id) : null;
    if(!panel) return;
    const expanded = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', String(!expanded));
    panel.hidden = expanded ? true : false;
  });

  // ƒê√≥ng drawer khi ch·ªçn b·∫•t k·ª≥ link
  drawer?.addEventListener('click', e=>{
    const a = e.target.closest('a');
    if(a) close();
  });
})();    
</script>
</body>
</html>
