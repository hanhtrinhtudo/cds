<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PTKV3 ‚Ä¢ H·ªçc t·∫≠p AI chuy√™n bi·ªát</title>

<link rel="stylesheet" href="css/nav.css?v=20251006">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#A41919; --accent:#FFD966; --bg:#FFF8ED; --text:#0f172a;
  --muted:#6b7280; --border:#e5e7eb; --radius:14px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
a{color:inherit;text-decoration:none} a:hover{color:#dc2626}

/* ===== Header/ Footer ===== */
.header{position:sticky;top:0;z-index:50;font-weight:600;background:linear-gradient(90deg,#7f1d1d,#b91c1c 45%,#dc2626);color:#fff}
.nav{max-width:1200px;margin:auto;display:flex;gap:18px;align-items:center;padding:12px 16px}
.nav .brand{font-weight:800}
.nav a{color:#fff;padding:6px 10px;border-radius:8px}
.nav a[aria-current="page"]{background:rgba(0,0,0,.18)}
.nav a:hover{color:var(--accent); transform:scale(1.04)}
.footer{margin-top:40px;background:#111827;color:#cbd5e1}
.footer .wrap{max-width:1200px;margin:auto;padding:20px 16px;font-size:14px}

/* ===== Page ===== */
.container{max-width:1200px;margin:0 auto;padding:16px}
.page-title{
  font-size: clamp(22px, 4.6vw, 32px);
  font-weight: 800;
  line-height: 1.5;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin: 10px 0 10px;
}
.section{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px}
.search-row{display:flex;gap:12px;align-items:center}
.search-row input{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:999px;background:#fff}

.grid{display:grid;gap:16px}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:980px){.grid-3{grid-template-columns:1fr}}

.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px}

/* --- Google-Drive like cards --- */
.grid-drive{
  display:grid; gap:16px;
  grid-template-columns:repeat(4,minmax(0,1fr));
}
@media(max-width:1200px){ .grid-drive{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
@media(max-width:900px) { .grid-drive{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
@media(max-width:560px) { .grid-drive{ grid-template-columns:1fr; } }

.drive-card{
  border:1px solid var(--border);
  border-radius:12px;
  background:#adb5d3;
  overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
  transition:.2s transform,.2s box-shadow;
  cursor:pointer;
}
.drive-card:hover{ transform:translateY(-3px); box-shadow:0 10px 18px rgba(0,0,0,.10); }

.drive-head{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px;
  background:#fff;
}
.drive-head .mime{
  width:20px; height:20px;
  background:#ef4444; color:#fff;
  font-weight:600; font-size:8px;
  display:flex; align-items:center; justify-content:center;
  border-radius:4px; flex-shrink:0;
}
.drive-title{
  font-weight:800; color:#111; flex:1; min-width:0;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

.drive-body{ padding:8px; background:#fff; }
.drive-frame{
  width:100%;
  aspect-ratio:16/9;
  background:#f3f4f6;
  border:1px solid #e5e7eb;
  border-radius:4px;
  overflow:hidden;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.6);
}
.drive-frame img{
  width:100%; height:100%;
  object-fit:cover; display:block; border:none;
}

.section.is-hidden{ display:none !important; }

.gd-footer{display:flex;justify-content:space-between;align-items:center;padding:8px 12px}
.gd-badge{border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px;color:#374151;background:#fff}
.gd-pill{background:#facc15;color:#111;border:none;border-radius:8px;padding:6px 10px;font-weight:700}
.badge{border:1px solid #d1d5db;border-radius:999px;font-size:12px;padding:3px 9px;background:#fff;color:#374151}
.btn{padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,#A41919,#C62828);color:#fff;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid var(--border);color:#111}

/* Viewer split */
.split{display:grid;grid-template-columns:1.3fr .7fr;gap:16px}
@media(max-width:1024px){.split{grid-template-columns:1fr}}
.viewer iframe{
  width:100%;
  min-height:72vh;   /* ch·ªâ cao kho·∫£ng 1 trang, kh√¥ng k√©o theo c·ªôt ph·∫£i */
  border:0;
  border-radius:12px;
  background:#000;
}

/* AI chat box */
.ai-dock{
  display:flex; flex-direction:column;
  border:1px solid #ffe08a; border-radius:14px; overflow:hidden; background:#fff;
  box-shadow:0 6px 18px rgba(0,0,0,.06);
}
.ai-dock .head{
  height:52px; font-weight: 600;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 14px;
  background:linear-gradient(180deg,#ffe470 0%,#facc15 100%);
  border-bottom:1px solid #ffe08a;
}
.ai-dock .head .btn{ display:none; }
.ai-dock .body{
  flex:1; min-height:260px; max-height:56vh;
  overflow:auto; padding:14px;
  background:#fff;
}
.bubble{ 
  padding:10px 12px; border-radius:12px; margin:8px 0; 
  max-width:90%; line-height:1.55; box-shadow:0 1px 2px rgba(0,0,0,.04);
}
.bubble.user{ background:#e8f0ff; margin-left:auto; }
.bubble.ai{ background:#fff8db; }
.bubble small{ display:block; margin-top:4px; color:#6b7280; }

.ai-dock .input{
  position:sticky; bottom:0; z-index:1;
  background:#fff; padding:12px 12px; 
  border-top:1px solid #ffe08a;
  display:flex; gap:10px; align-items:center;
}
.ai-dock .input input{
  flex:1; height:46px; border-radius:9999px; font-size:15px;
  padding:0 16px;
  border:1px solid #e5e7eb; outline:none;
  box-shadow:inset 0 1px 0 rgba(0,0,0,.02);
}
.ai-dock .input input:focus{
  border-color:#f59e0b; box-shadow:0 0 0 3px rgba(245,158,11,.2);
}
.ai-dock .btn#aiSend{
  height:46px; min-width:52px; padding:0 18px;
  border-radius:12px; border:none; cursor:pointer;
  background:linear-gradient(180deg,#ffb13b,#f59e0b);
  color:#111; font-weight:600; letter-spacing:.2px;
  box-shadow:0 2px 0 rgba(0,0,0,.06), 0 8px 16px rgba(245,158,11,.18);
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  transition:transform .12s ease, filter .12s ease;
}
.ai-dock .btn#aiSend:hover{ filter:brightness(.98); transform:translateY(-1px); }
.ai-dock .btn#aiSend:active{ transform:translateY(0); }

/* Quiz */
.quiz .q{margin:8px 0 4px;font-weight:700}
.quiz ul{padding-left:0;margin:8px 0}
.quiz li{list-style:none;margin:6px 0;padding:8px;border:1px solid var(--border);border-radius:10px;display:flex;gap:8px;align-items:center}
.quiz .nav{display:flex;gap:8px;margin-top:8px}
.result-card{background:#ecfdf5;border:1px solid #bbf7d0;border-radius:12px;padding:12px;margin-top:8px}

.spinner{width:34px;height:34px;border:3px solid #ddd;border-top-color:#A41919;border-radius:50%;animation:spin 1s linear infinite;margin:16px auto}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{padding:24px;border:1px dashed #ddd;border-radius:14px;text-align:center;color:#6b7280}

/* N√∫t back */
.btn.back{
  display:inline-flex;
  align-items:center; justify-content:center;
  gap:8px;
  background:#f2760a;
  color:#fbfbfb;
  border:2px solid #f7fb00;
  border-radius:9999px;
  padding:10px 18px;
  font-weight:700;
  font-size: 14px;
  white-space:nowrap; 
  min-height:42px;
  box-shadow:0 2px 0 rgba(244, 3, 3, 0.12);
}
.btn.back:hover{
  filter:brightness(0.98);
  transform:translateY(-1px);
}
.btn.back:active{ transform:translateY(0); }

/* Search bar */
#searchBar.section{
  background: transparent;
  border: 0;
  padding: 0;
  margin: 8px 0 18px;
}
.search-row{
  position: relative;
  display: flex;
  align-items: center;
  gap: 0;
}
.search-row input{
  flex: 1;
  height: 54px;
  padding: 0 56px 0 52px;
  border: 1px solid #e5e7eb;
  border-radius: 9999px;
  background: #fff;
  font-size: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,.04) inset, 0 2px 8px rgba(0,0,0,.04);
  outline: none;
}
.search-row input:focus{
  border-color: #f59e0b;
  box-shadow: 0 0 0 4px rgba(245,158,11,.18);
}
.search-row::before{
  content: "üîé";
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  opacity: .6;
  pointer-events: none;
}
#btnFind{
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);
  width: 70px;
  height: 42px;
  padding: 0 18px;
  border: none;
  border-radius: 999px;
  font-weight: 600;
  background: linear-gradient(90deg,#a41919,#c62828);
  color: #fff;
  cursor: pointer;
  box-shadow: 0 2px 0 rgba(0,0,0,.08), 0 10px 18px rgba(164,25,25,.18);
  transition: transform .12s ease, filter .12s ease;
}
@media (max-width: 640px){
  .search-row input{ height: 50px; padding: 0 54px 0 48px; }
  #btnFind{ height: 40px; padding: 0 16px; }
}

/* Mobile nav */
.m-toggle{
  display:none !important;
  background:transparent; border:0; color:#fff;
  font-size:28px; line-height:1;
}
@media (max-width:1024px){
  .nav a:not(.brand){display:none !important;}
  .m-toggle{display:block !important;margin-left:auto;}

  .m-drawer{
    position:fixed; inset:0 auto 0 0; width:86vw; max-width:420px;
    transform:translateX(-100%);
    background:linear-gradient(180deg,#7f1d1d,#b91c1c 55%,#9d1414);
    color:#fff; z-index:120; transition:transform .25s ease;
    box-shadow:4px 0 30px rgba(0,0,0,.25);
  }
  .m-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(2px);
    z-index:110; opacity:0; transition:opacity .25s; pointer-events:none;
  }
  body.menu-open .m-drawer{transform:translateX(0)}
  body.menu-open .m-backdrop{opacity:1; pointer-events:auto}
}

/* Quiz tabs: √în t·∫≠p / Ki·ªÉm tra HL */
.quiz-tabs{
  display:flex;
  gap:8px;
  margin-bottom:10px;
}
.quiz-tabs .tab-btn{
  flex:1;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid #e5e7eb;
  background:#f9fafb;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
}
.quiz-tabs .tab-btn.active{
  background:#A41919;
  color:#fff;
  border-color:#A41919;
}
@media(max-width:768px){
  .split{gap:12px}
}
</style>

<script>
// ===== C·∫§U H√åNH API =====
window.PTKV3_API = 'https://script.google.com/macros/s/AKfycbzZiadEwXNqaT7ipKilO7Aqt48bTB2h6jNC7gCiO0TMb0TSRxKsvINWVscxQooWTzlV/exec';
</script>
</head>

<body>
<header class="header">
  <nav class="nav" role="navigation">
    <a class="brand" href="index.html">BAN CH·ªà HUY PTKV3</a>
    <a href="index.html">Trang ch·ªß</a>
    <a href="tintuc24.html">Tin t·ª©c</a>
    <a href="Hoctap.html" aria-current="page">H·ªçc t·∫≠p</a>
    <a href="kiemtra.html">Ki·ªÉm tra</a>
    <a href="xephang.html">K·∫øt qu·∫£ ki·ªÉm tra</a>
    <button class="m-toggle" aria-label="M·ªü menu">‚ò∞</button>
  </nav>
</header>

<!-- mobile drawer (gi·ªØ b·∫£n ƒë∆°n gi·∫£n) -->
<aside id="mDrawer" class="m-drawer" aria-hidden="true">
  <div class="m-head" style="padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.12);display:flex;align-items:center;gap:10px">
    <span style="font-weight:800">BAN CH·ªà HUY PTKV3</span>
    <button class="m-close" style="margin-left:auto;background:0;border:0;color:#fff;font-size:26px">‚úï</button>
  </div>
  <nav class="m-menu" style="padding:8px 8px 18px">
    <a class="m-item" href="index.html">Trang ch·ªß</a>
    <a class="m-item" href="tintuc24.html">Tin t·ª©c</a>
    <a class="m-item" href="Hoctap.html" aria-current="page">H·ªçc t·∫≠p</a>
    <a class="m-item" href="kiemtra.html">Ki·ªÉm tra</a>
    <a class="m-item" href="xephang.html">K·∫øt qu·∫£ ki·ªÉm tra</a>
  </nav>
</aside>
<div class="m-backdrop" hidden></div>

<div class="container">
  <h1 class="page-title">H·ªåC T·∫¨P CHUY√äN ƒê·ªÄ</h1>

  <section id="searchBar" class="section">
    <div class="search-row">
      <input id="kw" placeholder="T√¨m t√†i li·ªáu theo t√™n, chuy√™n ƒë·ªÅ...">
      <button class="btn" id="btnFind" type="button">T√¨m</button>
    </div>
  </section>

  <section id="materials-list"></section>
</div>

<footer class="footer">
  <div class="wrap">
    <strong>PTKV3 ‚Ä¢ Trung t√¢m Gi√°o d·ª•c Ch√≠nh tr·ªã s·ªë ¬© 2025</strong>
  </div>
</footer>
<script>
// ===== H·ªí S∆† ƒêƒÇNG NH·∫¨P (d√πng chung v·ªõi navbar) =====
const AUTH_API = 'https://script.google.com/macros/s/AKfycbzmpvNrN87fv6EM3fA_-Y7VabWKs6R17PYJp8B4BE5nzIKCpfkOPRO1JE7ZoiEBYNKd/exec';
const LS_PROFILE = 'ctct_profile';

function getProfile(){
  try{
    const raw = localStorage.getItem(LS_PROFILE);
    if(!raw) return null;
    const p = JSON.parse(raw);
    if(!p || !p.name) return null;
    return p;          // {name, unit, position}
  }catch(e){
    return null;
  }
}
async function ensureProfileFromAuth(){
  let prof = getProfile();
  if (prof && prof.unit) return prof;

  const token = (localStorage.getItem('ctct_token') || '').trim();
  if (!token) return null;

  try{
    const res = await fetch(AUTH_API+'?action=me', {
      method:'POST',
      headers:{'Content-Type':'text/plain; charset=utf-8'},
      body: JSON.stringify({ token })
    });
    const data = await res.json();
    if (!data || !data.ok || !data.user) return null;

    const u = data.user;
    prof = {
      name:     u.name || u.username || '',
      unit:     u.unit || '',
      position: '' // AUTH hi·ªán ch∆∞a tr·∫£ ch·ª©c v·ª•, sau n√†y m√¨nh c√≥ th·ªÉ b·ªï sung
    };
    localStorage.setItem(LS_PROFILE, JSON.stringify(prof));
    return prof;
  }catch(err){
    console.warn('ensureProfileFromAuth error', err);
    return null;
  }
}

// H√†m chuy·ªÉn sang login, gi·ªØ l·∫°i trang hi·ªán t·∫°i
function redirectToLogin(){
  const here = location.pathname.split('/').pop() || 'Hoctap.html';
  const url  = 'login.html?redirect=' + encodeURIComponent(here);
  location.href = url;
}
// ===== CORE HELPERS =====
async function apiCall(action, payload = {}) {
  if (!window.PTKV3_API) throw new Error('Ch∆∞a c·∫•u h√¨nh PTKV3_API');
  const u = new URL(window.PTKV3_API);
  const qs = JSON.stringify(payload);
  u.searchParams.set('action', action);
  u.searchParams.set('payload', qs);
  if (u.toString().length > 1800) {
    const res = await fetch(window.PTKV3_API, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
      body: JSON.stringify({ action, payload })
    });
    const data = await res.json(); if (!data.ok) throw new Error(data.error||'API error'); return data.data||{};
  }
  const res = await fetch(u.toString(), { method: 'GET' });
  const data = await res.json(); if (!data.ok) throw new Error(data.error||'API error'); return data.data||{};
}
const el=(t,a={},c=[])=>{const e=document.createElement(t);Object.entries(a).forEach(([k,v])=>{if(k==='class')e.className=v;else if(k==='html')e.innerHTML=v;else e.setAttribute(k,v)});(Array.isArray(c)?c:[c]).filter(Boolean).forEach(ch=>e.append(ch));return e;}
const spinner=()=>{const d=document.createElement('div');d.className='spinner';return d;}
const showEmpty=(t,m)=>{t.innerHTML='';t.append(el('div',{class:'empty'},m));}

function driveThumb(fileId){
  return `https://drive.google.com/thumbnail?id=${encodeURIComponent(fileId)}&sz=w900`;
}
function toggleSearch(show){
  const s = document.getElementById('searchBar');
  if (s) s.style.display = show ? '' : 'none';
}
const STORAGE = {
  CURRENT: 'ptkv3.currentMaterial',
  CHAT_PREFIX: 'ptkv3.chat.'
};

// ===== QUIZ HELPERS =====
async function quizHasQuestions(fileId){
  try{ const d = await apiCall('quiz.has',{fileId}); return !!(d && d.count>0); }catch(_){return false;}
}
function cleanTitle(s=''){
  return String(s).replace(/\.(pdf|docx?|pptx?|xlsx?)$/i,'');
}

/* ===== LIST PAGE ===== */
const $list = document.getElementById('materials-list');
document.getElementById('btnFind').addEventListener('click', ()=> searchAndMount($list, document.getElementById('kw').value));
document.getElementById('kw').addEventListener('keydown', e=>{ if(e.key==='Enter') searchAndMount($list, e.target.value); });

async function searchAndMount(container, keyword=''){ await mountMaterials(container, keyword); }

async function mountMaterials(container, keyword=''){
  container.innerHTML=''; container.append(spinner());
  try{
    const data = await apiCall('tailieu.danh-sach', {'tu-khoa': keyword});
    container.innerHTML='';
    const gridWrap = el('div',{class:'grid-drive'});
    const items = data.items || [];
    const flags = await Promise.all(items.map(m=>quizHasQuestions(m.fileId)));

    items.forEach((m, idx)=>{
      const hasQuiz = !!flags[idx];
      const titleClean = cleanTitle(m['tieu-de']||'');
      const card = el('div',{class:'drive-card'});
      card.style.cursor = 'pointer';
      card.setAttribute('tabindex','0');

      const head = el('div',{class:'drive-head'});
      head.append(el('span',{class:'mime'},'PDF'));
      head.append(el('div',{class:'drive-title'}, titleClean));
      head.append(el('span',{style:'opacity:.4'},'‚ãÆ'));
      card.append(head);

      const thumbSrc = (m.thumbnail && m.thumbnail.trim()) ? m.thumbnail : driveThumb(m.fileId);
      const body  = el('div',{class:'drive-body'});
      const frame = el('div',{class:'drive-frame'});
      frame.append(el('img',{src:thumbSrc, alt:titleClean}));
      body.append(frame); card.append(body);

      if (m['chu-de']) {
        const meta = el('div',{style:'padding:0 12px 12px'});
        meta.append(el('span',{class:'badge'}, m['chu-de']));
        card.append(meta);
      }

      if (!hasQuiz){
        const act = el('div',{style:'padding:0 12px 12px;display:flex;justify-content:flex-start'});
        const btn = el('button',{class:'btn',type:'button',style:'background:#facc15;color:#111;font-weight:700;border:none'},'√în t·∫≠p');
        btn.onclick = (e)=>{ e.stopPropagation(); mountQuizOnly(container,m); };
        act.append(btn); card.append(act);
      }

      card.addEventListener('click', ()=> mountMaterialView(container, m));
      gridWrap.append(card);
    });

    if(!gridWrap.children.length){ showEmpty(container,'Ch∆∞a c√≥ t√†i li·ªáu.'); return; }
    container.append(gridWrap);
    toggleSearch(true);
  }catch(e){
    showEmpty(container,'L·ªói t·∫£i d·ªØ li·ªáu: '+ (e && e.message ? e.message : e));
  }
}

/* ===== AI DOCK ===== */
function openAIDock(fileMeta, targetEl, opts = { reset: false }){
  const mountAt = targetEl || document.body;
  const oldDock = document.querySelector('.ai-dock');
  if (oldDock) oldDock.remove();

  const chatKey = STORAGE.CHAT_PREFIX + fileMeta.fileId;
  if (opts.reset) sessionStorage.removeItem(chatKey);

  const dock = document.createElement('div');
  dock.className = 'ai-dock';
  dock.innerHTML = `
    <div class="head">
      <span>Tr√≤ chuy·ªán v·ªõi AI</span>
      <div style="display:flex;gap:6px">
        <button id="aiMin" class="btn" aria-hidden="true">‚àí</button>
        <button id="aiClose" class="btn" aria-hidden="true">√ó</button>
      </div>
    </div>
    <div class="body" id="aiBody"></div>
    <div class="input">
      <input id="aiInput" placeholder="Nh·∫≠p c√¢u h·ªèi..." />
      <button id="aiSend" class="btn">G·ª≠i</button>
    </div>
  `;
  mountAt.prepend(dock);

  const box = dock.querySelector('#aiBody');
  const inp = dock.querySelector('#aiInput');
  const btn = dock.querySelector('#aiSend');

  const esc = s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const add = (who, html)=>{
    const div = document.createElement('div');
    div.className = 'bubble ' + (who==='user' ? 'user' : 'ai');
    div.innerHTML = html;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  };
  const saveChat = ()=>{
    const nodes = [...box.querySelectorAll('.bubble')].map(n=>({
      who: n.classList.contains('user')?'user':'ai',
      html: n.innerHTML
    }));
    sessionStorage.setItem(chatKey, JSON.stringify(nodes));
  };
  const restoreChat = () => {
  const raw = sessionStorage.getItem(chatKey);
  box.innerHTML = '';

  if (!raw) {
    // Kh√¥ng th√™m l·ªùi ch√†o m·∫∑c ƒë·ªãnh n·ªØa,
    // ƒë·ªÉ tr·ªëng, ch·ªù ng∆∞·ªùi d√πng nh·∫Øn th√¨ m·ªõi tr·∫£ l·ªùi.
    return;
  }

  try {
    const arr = JSON.parse(raw);
    arr.forEach(m => add(m.who, m.html));
  } catch (e) {
    console.warn('Kh√¥i ph·ª•c chat th·∫•t b·∫°i:', e);
    // N·∫øu l·ªói parse th√¨ c≈©ng ƒë·ªÉ tr·ªëng lu√¥n
  }
};

  const ask = async ()=>{
    const q = inp.value.trim(); if(!q) return;
    add('user', esc(q)); inp.value='';
    saveChat();
    const wait = document.createElement('div'); wait.className='bubble ai'; wait.textContent='ƒêang suy nghƒ©...'; box.append(wait);

    try{
      const r = await apiCall('ai.chat',{ fileId:fileMeta.fileId, section:'', 'cau-hoi': q });
      const src = r.source ? `<small>üìö Ngu·ªìn: ${esc(r.source)}</small>` : '';
      wait.innerHTML = (r.answer || '(kh√¥ng c√≥ ph·∫£n h·ªìi)').replace(/\n/g,'<br>') + src;
    }catch(e){
      wait.innerHTML = '<b>L·ªói:</b> ' + esc(e.message||e);
    }
    saveChat();
    box.scrollTop = box.scrollHeight;
  };

  inp.onkeydown = (e)=>{ if(e.key==='Enter'){ e.preventDefault(); ask(); } };
  btn.onclick = ask;

  restoreChat();
}

/* ===== MATERIAL VIEW: viewer + AI + quiz tabs ===== */
async function mountMaterialView(root, meta){
  root.innerHTML='';
  const searchSection = document.getElementById('searchBar');
  if (searchSection) searchSection.classList.add('is-hidden');

  localStorage.setItem(STORAGE.CURRENT, JSON.stringify({fileId: meta.fileId, 'tieu-de': meta['tieu-de']||'T√†i li·ªáu'}));

  const backToList = ()=>{
    if(searchSection) searchSection.classList.remove('is-hidden');
    localStorage.removeItem(STORAGE.CURRENT);
    mountMaterials(root);
  };

  const titleClean = cleanTitle(meta['tieu-de']||'T√†i li·ªáu');
  const bar = el('div',{class:'card'});
  bar.append(el('div',{html:`
    <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
      <h2 style="margin:0;font-size:22px;font-weight:800;color:#7f1d1d">${titleClean}</h2>
      <button class="btn back" id="back">Quay l·∫°i chuy√™n ƒë·ªÅ</button>
    </div>`}));
  bar.querySelector('#back').onclick = backToList;
  root.append(bar);

  const wrap = el('div',{class:'split'});

  // LEFT
  const viewer = el('section',{class:'section viewer'});
  const iframe = el('iframe',{src:`https://drive.google.com/file/d/${meta.fileId}/preview`,allow:'autoplay'});
  viewer.append(iframe);
  wrap.append(viewer);

  // RIGHT
  const right = el('div',{class:'grid'});
  openAIDock(meta, right);

  // Quiz tabs section
  const quizBox = el('section',{class:'section quiz'});
  quizBox.innerHTML = `
    <div class="quiz-tabs">
      <button type="button" class="tab-btn active" data-tab="review">√în t·∫≠p</button>
      <button type="button" class="tab-btn" data-tab="final">üìù Ki·ªÉm tra k·∫øt th√∫c HL</button>
    </div>
    <div id="quizReviewPane"></div>
    <div id="quizFinalPane" style="display:none"></div>
  `;
  const reviewPane = quizBox.querySelector('#quizReviewPane');
  const finalPane  = quizBox.querySelector('#quizFinalPane');

  quizBox.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      quizBox.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b===btn));
      const tab = btn.dataset.tab;
      reviewPane.style.display = (tab==='review') ? 'block' : 'none';
      finalPane.style.display  = (tab==='final')  ? 'block' : 'none';
    });
  });

  right.append(quizBox);
  wrap.append(right);
  root.append(wrap);

  // load quiz 1 l·∫ßn, d√πng chung cho c·∫£ 2 tab
  try{
    const data = await apiCall('quiz.getByFile',{fileId:meta.fileId,limit:20});
    const items = data.items || [];

    if(!items.length){
      reviewPane.innerHTML = '<div class="empty">Ch∆∞a c√≥ c√¢u h·ªèi √¥n t·∫≠p cho t√†i li·ªáu n√†y.</div>';
      finalPane.innerHTML  = '<div class="empty">Ch∆∞a c√≥ b·ªô c√¢u h·ªèi k·∫øt th√∫c hu·∫•n luy·ªán cho t√†i li·ªáu n√†y.</div>';
      return;
    }

    // === √îN T·∫¨P ===
    const stateR = { idx:0, answers:{} };
    const renderReview = ()=>{
    const it = items[stateR.idx];
    reviewPane.innerHTML = `
      <div class="q">C√¢u ${stateR.idx+1}/${items.length}. ${it.q}</div>
      <ul>
        ${it.options.map(op=>`
          <li><label>
            <input type="radio" name="qr${stateR.idx}" value="${op}" ${stateR.answers[stateR.idx]===op?'checked':''}>
            ${op}
          </label></li>
        `).join('')}
      </ul>
      <div class="nav">
        <button class="btn ghost" id="rPrev" ${stateR.idx===0?'disabled':''}>Quay l·∫°i</button>
        ${stateR.idx<items.length-1
          ? '<button class="btn" id="rNext">Ti·∫øp t·ª•c</button>'
          : '<button class="btn" id="rFinish">K·∫øt th√∫c</button>'}
      </div>
    `;
    reviewPane.querySelectorAll('input[type="radio"]').forEach(r=>{
      r.onchange = ()=>{ stateR.answers[stateR.idx]=r.value; };
    });
    const p=reviewPane.querySelector('#rPrev'),
          n=reviewPane.querySelector('#rNext'),
          f=reviewPane.querySelector('#rFinish');
    if(p) p.onclick=()=>{ stateR.idx--; renderReview(); };
    if(n) n.onclick=()=>{ stateR.idx++; renderReview(); };
    if(f) f.onclick=finishReview;
  };
  const finishReview = ()=>{
  let correct=0; items.forEach((it,i)=>{ if(stateR.answers[i]===it.answer) correct++; });
  const total=items.length, pct=Math.round(correct*100/total);
  reviewPane.innerHTML = `
    <div class="result-card">
      <div style="font-weight:800;font-size:18px;">üéâ B·∫°n ƒë√£ ho√†n th√†nh ph·∫ßn √¥n t·∫≠p!</div>
      <div style="margin-top:6px">K·∫øt qu·∫£: <strong>${correct}/${total}</strong> (${pct}%).</div>
      <div style="margin-top:4px;font-size:13px;color:#6b7280">
        Ph·∫ßn √¥n t·∫≠p ch·ªâ gi√∫p ghi nh·ªõ, kh√¥ng l∆∞u ƒëi·ªÉm v√†o s·ªï.
      </div>
    </div>`;
  };
  renderReview();

    // === KI·ªÇM TRA K·∫æT TH√öC HL ===
    finalPane.innerHTML = `
      <p style="margin:0 0 10px;font-size:14px;color:#4b5563">
        Sau khi √¥n t·∫≠p xong, b·∫•m n√∫t b√™n d∆∞·ªõi ƒë·ªÉ l√†m b√†i <strong>Ki·ªÉm tra k·∫øt th√∫c hu·∫•n luy·ªán</strong>.
      </p>
      <button type="button" class="btn" id="btnStartFinal">B·∫Øt ƒë·∫ßu ki·ªÉm tra</button>
      <div id="finalInner" style="margin-top:12px;"></div>
    `;
    const finalInner = finalPane.querySelector('#finalInner');
    finalPane.querySelector('#btnStartFinal').onclick = ()=> prepareFinalExam(items, finalInner, meta);

  }catch(e){
    reviewPane.innerHTML = '<div class="empty">Kh√¥ng t·∫£i ƒë∆∞·ª£c c√¢u h·ªèi: '+e.message+'</div>';
    finalPane.innerHTML  = '<div class="empty">Kh√¥ng t·∫£i ƒë∆∞·ª£c c√¢u h·ªèi ki·ªÉm tra: '+e.message+'</div>';
  }
}
// Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi cho l√†m b√†i ki·ªÉm tra k·∫øt th√∫c HL
async function prepareFinalExam(items, container, meta){
  // 1) Th·ª≠ l·∫•y profile t·ª´ localStorage
  let prof = getProfile();

  // 2) N·∫øu ch∆∞a c√≥ ho·∫∑c ch∆∞a c√≥ ƒë∆°n v·ªã ‚áí th·ª≠ g·ªçi AUTH /me b·∫±ng token
  if (!prof || !prof.unit){
    const token = (localStorage.getItem('ctct_token') || '').trim();
    if (token){
      try{
        prof = await ensureProfileFromAuth();
      }catch(e){
        prof = null;
      }
    }
  }

  // 3) N·∫øu v·∫´n ch∆∞a c√≥ h·ªì s∆° h·ª£p l·ªá ‚áí chuy·ªÉn sang login
  if (!prof || !prof.unit){
    // Ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p / ch∆∞a c√≥ ƒë∆°n v·ªã ‚áí y√™u c·∫ßu ƒëƒÉng nh·∫≠p
    redirectToLogin();
    return;
  }

  // ‚úÖ ƒê√£ c√≥ h·ªì s∆° ƒë·∫ßy ƒë·ªß ‚áí cho l√†m b√†i lu√¥n
  startFinalExam(items, container, meta);
}

// final exam
function startFinalExam(items, container, meta){
  // --- Ki·ªÉm tra ƒëƒÉng nh·∫≠p & ƒë∆°n v·ªã ---
  const prof = (typeof getProfile === 'function') ? getProfile() : null;
  if (!prof || !prof.name || !prof.unit){
    // ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c ch∆∞a c√≥ ƒë∆°n v·ªã -> chuy·ªÉn sang login
    const ret = encodeURIComponent(window.location.pathname + window.location.search);
    window.location.href = `login.html?redirect=${ret}`;
    return;
  }

  // ·∫®n n√∫t "B·∫Øt ƒë·∫ßu ki·ªÉm tra" sau khi v√†o ƒë·ªÅ
  const btn = document.getElementById('btnStartFinal');
  if (btn){
    btn.disabled = true;
    btn.style.display = 'none';
  }

  const stateF = { idx:0, answers:{} };

  const renderFinal = ()=>{
    const it = items[stateF.idx];
    container.innerHTML = `
      <div class="q">C√¢u ${stateF.idx+1}/${items.length}. ${it.q}</div>
      <ul>
        ${it.options.map(op=>`
          <li><label>
            <input type="radio" name="qf${stateF.idx}" value="${op}" ${stateF.answers[stateF.idx]===op?'checked':''}>
            ${op}
          </label></li>
        `).join('')}
      </ul>
      <div class="nav">
        <button class="btn ghost" id="fPrev" ${stateF.idx===0?'disabled':''}>Quay l·∫°i</button>
        ${stateF.idx<items.length-1
          ? '<button class="btn" id="fNext">Ti·∫øp t·ª•c</button>'
          : '<button class="btn" id="fFinish">N·ªôp b√†i</button>'}
      </div>
    `;
    container.querySelectorAll('input[type="radio"]').forEach(r=>{
      r.onchange = ()=>{ stateF.answers[stateF.idx]=r.value; };
    });
    const p=container.querySelector('#fPrev'),
          n=container.querySelector('#fNext'),
          f=container.querySelector('#fFinish');
    if(p) p.onclick=()=>{ stateF.idx--; renderFinal(); };
    if(n) n.onclick=()=>{ stateF.idx++; renderFinal(); };
    if(f) f.onclick=()=> submitFinalExam(items, stateF, container, meta);
  };

  renderFinal();
}

async function submitFinalExam(items, stateF, container, meta){
  let correct = 0;
  items.forEach((it,i)=>{ if(stateF.answers[i]===it.answer) correct++; });
  const total = items.length;
  const pct   = Math.round(correct*100/total);

  const prof = getProfile() || {};
  const fullName = prof.name || '';
  const unit     = prof.unit || '';

  container.innerHTML = '<div class="spinner"></div>';

  try{
    await apiCall('exam.saveResult',{
      fileId:   meta.fileId,
      title:    meta['tieu-de'] || 'T√†i li·ªáu',
      correct, total, score:pct,
      fullName, unit
    });

    container.innerHTML = `
      <div class="result-card">
        <div style="font-weight:800;font-size:18px;">üèÖCh√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh n·ªôi dung ki·ªÉm tra</div>
        <div style="margin-top:6px">B·∫°n tr·∫£ l·ªùi ƒë√∫ng <strong>${correct}/${total}</strong> c√¢u (${pct}%).</div>
        <div style="margin-top:4px;font-size:13px;color:#16a34a">
          ‚úÖ ƒêi·ªÉm ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n trong s·ªï th·ªëng k√™ hu·∫•n luy·ªán.
        </div>
      </div>
      <hr style="margin:16px 0">
      <div style="font-size:13px;">
        <strong>K·∫øt qu·∫£ hu·∫•n luy·ªán (d√†nh cho gi√°o vi√™n)</strong><br>
        <span style="color:#6b7280">Nh·∫≠p m√£ gi√°o vi√™n ƒë·ªÉ xem danh s√°ch ng∆∞·ªùi h·ªçc ƒë√£ l√†m b√†i.</span>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <input id="gvPin" placeholder="M√£ gi√°o vi√™n" style="padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;min-width:160px;font-size:13px;">
        <button class="btn ghost" id="btnGV" type="button" style="padding:8px 12px;font-size:13px;">Xem k·∫øt qu·∫£</button>
      </div>
      <div id="gvResult" style="margin-top:10px;"></div>
    `;
    document.getElementById('btnGV').onclick = ()=> loadResultsForTeacher(meta, document.getElementById('gvResult'));

  }catch(err){
    container.innerHTML = `
      <div class="empty">
        Kh√¥ng l∆∞u ƒë∆∞·ª£c k·∫øt qu·∫£: ${err && err.message ? err.message : err}.
      </div>`;
  }
}


async function loadResultsForTeacher(meta, out){
  const pin = (document.getElementById('gvPin').value || '').trim();
  if(pin !== 'PTKV3'){
    out.innerHTML = '<div class="empty">M√£ gi√°o vi√™n kh√¥ng ƒë√∫ng.</div>';
    return;
  }
  out.innerHTML = '<div class="spinner"></div>';
  try{
    const data  = await apiCall('exam.listResults',{fileId: meta.fileId});
    const items = data.items || [];
    if(!items.length){
      out.innerHTML = '<div class="empty">Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o cho n·ªôi dung n√†y.</div>';
      return;
    }
    const rows = items.map((r,i)=>{
  const pct   = Number(r.score || 0);            // % l∆∞u trong sheet
  const diem  = (pct / 10).toFixed(1)            // chuy·ªÉn sang thang 10, 1 s·ªë l·∫ª
                    .replace(/\.0$/,'');         // n·∫øu 6.0 -> 6 cho g·ªçn

  return `
    <tr>
      <td>${i+1}</td>
      <td>${r.fullName || '-'}</td>
      <td>${r.unit || '-'}</td>
      <td>${r.title || '-'}</td>
      <td style="text-align:center">${diem}</td>
      <td style="text-align:center">${r.grade || ''}</td>
    </tr>
  `;
}).join('');

    out.innerHTML = `
      <div style="max-height:260px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;">
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead style="background:#f9fafb;position:sticky;top:0;">
            <tr>
              <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">TT</th>
              <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">H·ªç v√† T√™n</th>
              <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">ƒê∆°n v·ªã</th>
              <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">N·ªôi dung ki·ªÉm tra</th>
              <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;text-align:center;">K·∫øt qu·∫£ (ƒëi·ªÉm)</th>
              <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;text-align:center;">X·∫øp lo·∫°i</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }catch(err){
    out.innerHTML = '<div class="empty">L·ªói t·∫£i k·∫øt qu·∫£: '+(err && err.message ? err.message : err)+'</div>';
  }
}

/* ===== Quiz-only page (n·∫øu b·∫•m √în t·∫≠p ri√™ng) ===== */
async function mountQuizOnly(root, meta){
  root.innerHTML='';
  const nav = el('div',{class:'card', html:`<button class="btn ghost" id="back">&larr; Quay l·∫°i H·ªçc t·∫≠p</button>`});
  nav.querySelector('#back').onclick = ()=> mountMaterials(root);
  root.append(nav);
  root.append(el('div',{class:'card',html:`<h2 style="margin:0">√în t·∫≠p: ${meta['tieu-de']||'T√†i li·ªáu'}</h2>`}));

  const quiz = el('section',{class:'section quiz'}); root.append(quiz);
  const box = el('div',{}); quiz.append(box);

  try{
    const data = await apiCall('quiz.getByFile',{fileId:meta.fileId,limit:10});
    const items = data.items||[];
    if(!items.length){ box.innerHTML = '<div class="empty">Ch∆∞a c√≥ c√¢u h·ªèi.</div>'; return; }

    const state = { idx:0, answers:{} };
    const render = ()=>{
      const it = items[state.idx];
      box.innerHTML = `
        <div class="q">C√¢u ${state.idx+1}/${items.length}. ${it.q}</div>
        <ul>
          ${it.options.map((op,i)=>`
            <li><label><input type="radio" name="qb${state.idx}" value="${op}" ${state.answers[state.idx]===op?'checked':''}> ${op}</label></li>
          `).join('')}
        </ul>
        <div class="nav">
          <button class="btn ghost" id="btnPrev" ${state.idx===0?'disabled':''}>Quay l·∫°i</button>
          ${state.idx<items.length-1
            ? '<button class="btn" id="btnNext">Ti·∫øp t·ª•c</button>'
            : '<button class="btn" id="btnFinish">K·∫øt th√∫c</button>'}
        </div>
      `;
      box.querySelectorAll('input[type="radio"]').forEach(r=>{ r.onchange = ()=>{ state.answers[state.idx]=r.value; }; });
      const prev=box.querySelector('#btnPrev'), next=box.querySelector('#btnNext'), fin=box.querySelector('#btnFinish');
      if(prev) prev.onclick = ()=>{ state.idx--; render(); };
      if(next) next.onclick = ()=>{ state.idx++; render(); };
      if(fin)  fin.onclick  = ()=> finish();
    };
    const finish = ()=>{
      let correct=0; items.forEach((it,i)=>{ if(state.answers[i]===it.answer) correct++; });
      const total=items.length, pct=Math.round(correct*100/total);
      box.innerHTML = `
        <div class="result-card">
          <div style="font-weight:800;font-size:18px;">üéâ Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh!</div>
          <div style="margin-top:6px">K·∫øt qu·∫£: <strong>${correct}/${total}</strong> (${pct}%).</div>
        </div>`;
    };
    render();
  }catch(e){ box.innerHTML='<div class="empty">Kh√¥ng t·∫°o ƒë∆∞·ª£c c√¢u h·ªèi: '+e.message+'</div>'; }
}

/* ===== boot ===== */
const saved = localStorage.getItem(STORAGE.CURRENT);
if (saved){
  const meta = JSON.parse(saved);
  if (!meta['tieu-de']) meta['tieu-de'] = 'T√†i li·ªáu';
  mountMaterialView(document.getElementById('materials-list'), meta);
}else{
  mountMaterials(document.getElementById('materials-list'));
}

/* ===== mobile drawer simple ===== */
(function(){
  const drawer   = document.getElementById('mDrawer');
  const backdrop = document.querySelector('.m-backdrop');
  const openBtn  = document.querySelector('.m-toggle');
  const closeBtn = drawer?.querySelector('.m-close');

  function open(){
    document.body.classList.add('menu-open');
    drawer?.setAttribute('aria-hidden','false');
    if (backdrop) backdrop.hidden = false;
  }
  function close(){
    document.body.classList.remove('menu-open');
    drawer?.setAttribute('aria-hidden','true');
    if (backdrop) backdrop.hidden = true;
  }
  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
})();
</script>
</body>
</html>




