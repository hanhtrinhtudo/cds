<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PTKV3 ‚Ä¢ B·∫£ng x·∫øp h·∫°ng hu·∫•n luy·ªán ch√≠nh tr·ªã</title>

<link rel="stylesheet" href="css/nav.css?v=20251006">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#A41919; --accent:#FFD966; --bg:#FFF8ED; --text:#0f172a;
  --muted:#6b7280; --border:#e5e7eb; --radius:14px;}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
a{color:inherit;text-decoration:none} a:hover{color:#dc2626}

/* ===== Header/ Footer ƒë·ªìng b·ªô Tintuc24 / Hoctap ===== */
.header{
  position:sticky;top:0;z-index:50;font-weight:600;
  background:linear-gradient(90deg,#7f1d1d,#b91c1c 45%,#dc2626); color:#fff;}
.nav{ max-width:1200px;margin:auto;display:flex;gap:18px;align-items:center; padding:12px 16px;}
.nav .brand{font-weight:800}
.nav a{color:#fff;padding:6px 10px;border-radius:8px}
.nav a[aria-current="page"]{background:rgba(0,0,0,.18)}
.nav a:hover{color:var(--accent); transform:scale(1.04)}
.footer{margin-top:40px;background:#111827;color:#cbd5e1}
.footer .wrap{max-width:1200px;margin:auto;padding:20px 16px;font-size:14px}

/* ===== Mobile nav (gi·ªëng Hoctap) ===== */
.m-toggle{ display:none !important; background:transparent; border:0; color:#fff; font-size:28px; line-height:1;}

/* ·∫®n drawer + backdrop tr√™n desktop */
.m-drawer{ display:none; }
.m-backdrop{ display:none; }

@media (max-width:1024px){
  .nav a:not(.brand), .nav .has-dropdown{display:none !important;}
  .m-toggle{display:block !important; margin-left:auto;}
  .m-drawer{
    display:block;
    position:fixed; inset:0 auto 0 0; width:86vw; max-width:420px;
    transform:translateX(-100%);
    background:linear-gradient(180deg,#7f1d1d,#b91c1c 55%,#9d1414);
    color:#fff; z-index:120; transition:transform .25s ease;
    box-shadow:4px 0 30px rgba(0,0,0,.25); }
  .m-head{display:flex; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.12)}
  .m-home{font-size:22px; text-decoration:none}
  .m-brand{font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .m-close{margin-left:auto; background:0 0; border:0; color:#fff; font-size:28px; cursor:pointer}
  .m-menu{padding:8px 8px 18px}
  .m-item{display:block; color:#fff; padding:14px 10px; font-weight:600; border-bottom:1px solid rgba(255,255,255,.08)}
  .m-sub{display:flex; flex-direction:column; gap:6px; padding:10px 10px 12px}
  .m-sub[hidden]{display:none !important;}
  .m-drop .caret{float:right}
  .m-drop[aria-expanded="true"] .caret{ transform: rotate(180deg); }
  .m-backdrop{
    display:block;
    position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(2px);
    z-index:110; opacity:0; transition:opacity .25s; pointer-events:none; }

  body.menu-open .m-drawer{transform:translateX(0)}
  body.menu-open .m-backdrop{opacity:1; pointer-events:auto}
  body.no-scroll{overflow:hidden}

  .m-menu .m-item[aria-current="page"]{ background: rgba(255,255,255,.16); border-left: 3px solid #FFD966; font-weight: 800; }}

/* ===== N√∫t ===== */
.btn{
  border-radius:999px;
  border:none;
  background:#f97316;
  color:#fff;
  font-size:14px;
  font-weight:600;
  padding:8px 18px;
  cursor:pointer;
  box-shadow:0 8px 18px rgba(248,113,22,.3);
}
.btn:hover{background:#ea580c;}
.btn-ghost{
  border-radius:999px;
  border:1px solid rgba(255,255,255,.7);
  background:rgba(248,250,252,.18);
  color:#fff;
  font-size:13px;
  font-weight:600;
  padding:6px 14px;
  cursor:pointer;
  backdrop-filter:blur(2px);
}
.btn-ghost:hover{background:rgba(255,255,255,.22);}

/* ===== Layout leaderboard ===== */
.page{
  min-height:100vh;
  background:
    radial-gradient(circle at 0% -60%, #f97316 0, transparent 55%),
    radial-gradient(circle at 100% -80%, #f97316 0, transparent 55%),
    linear-gradient(180deg,#c81e1e 0%,#f97316 40%,#fef3c7 76%,var(--bg) 76%);
}
.shell{
  max-width:1200px;
  margin:0 auto;
  padding:16px 12px 40px;
}
.hero{
  display:grid;
  grid-template-columns:minmax(0,1.5fr) minmax(0,1fr);
  align-items:center;
  gap:18px;
  padding:18px 0 14px;
}
@media(max-width:900px){
  .hero{grid-template-columns:1fr; padding-top:24px;}
}
.hero-title{
  margin-bottom: 6px;
  font-size:34px;
  font-weight:800;
  line-height:1.1;
  text-transform:uppercase;
  letter-spacing:.03em;
  color:#fff;                /* ‚úÖ s√°ng h∆°n tr√™n n·ªÅn cam */
  margin:0 0 10px;
}
.hero-sub{
  font-size:15px;
  color:#fef9c3;             /* ‚úÖ v√†ng nh·∫°t */
  opacity:1;
}
.hero-controls{
  margin-top:16px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}
.hero-search-btn{ border-radius:999px;
  border:none;
  padding:8px 20px;
  font-size:14px;
  font-weight:600;
  background:#f97316;
  color:#fff;
  cursor:pointer;
  box-shadow:0 10px 24px rgba(0,0,0,.14);
  display:inline-flex;
  align-items:center;
  gap:6px;}
.hero-search-btn span{font-size:18px;}
/* Toggle C√° nh√¢n / T·∫≠p th·ªÉ */
.view-toggle{
  display:inline-flex;
  background:rgba(255,255,255,.22);
  padding:4px;
  border-radius:999px;
  box-shadow:0 10px 24px rgba(0,0,0,.14);
  gap:4px;
}
.pill-lg{
  border-radius:999px;
  border:none;
  background:transparent;
  padding:6px 22px;
  font-size:13px;
  color:#fef2f2;
  font-weight:600;
  cursor:pointer;
}
.pill-lg.active{
  background:#ffffff;
  color:#b91c1c;
  box-shadow:0 8px 18px rgba(248,113,22,.25);
}

.hero-tools{display:none;}

/* Tr·∫°ng th√°i t·∫£i */
.status{font-size:13px;color:#fef2f2;margin:0;}

/* Huy ch∆∞∆°ng l·ªõn */
.hero-medal{justify-self:end; margin-right:80px;}
.hero-medal-img{ width:200px; height:auto; display:block;}

/* Section title + tabs con */
.section-title{
  margin-top:4px;           /* ‚úÖ k√©o g·∫ßn l√™n, b·ªõt kho·∫£ng tr·ªëng */
  font-size:14px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.08em;
  color:#374151;            /* ‚úÖ ƒë·∫≠m h∆°n ch√∫t */
}
.section-title + .sub-tabs{margin-top:12px;}

.sub-tabs{ display:flex; gap:10px;margin-top: 6px;}
.pill-sm{
  border-radius:999px;
  border:1px solid transparent;
  background:#f4ede4;
  padding:6px 16px;
  font-size:13px;
  color:#374151;
  cursor:pointer;
}
.pill-sm.active{ background:#fff; border-color:#f97316; box-shadow:0 6px 16px rgba(248,113,22,.22); font-weight:600;}

/* Top 3 card */
.top3-card{
  margin-top:18px;
  background:transparent;
  border-radius:0;
  box-shadow:none;
  padding:12px 24px 10px;
  max-width:820px;
  margin-left:auto;
  margin-right:auto;
  display:flex;
  justify-content:center;
  align-items:flex-end;
  gap:18px;
  flex-wrap:wrap;
}
@media(max-width:900px){
  .top3-card{ flex-direction:column; align-items:center; }}

.top-item{ text-align:center; font-size:14px; position:relative; min-width:180px;}
.top-item--first{transform:translateY(-6px);}
.top-item--second,
.top-item--third{transform:translateY(4px);}
.top-medal-img{ display:block; margin:0 auto 10px; filter:drop-shadow(0 12px 22px rgba(0,0,0,.25));}
.top-item--first  .top-medal-img{width:150px;}
.top-item--second .top-medal-img{width:130px;}
.top-item--third  .top-medal-img{width:130px;}
.top-item-name{ margin-top:3px; font-size: 16px; font-weight: 800; color:#b91c1c; text-transform:none;
text-shadow:
      -1px -1px 0 #FFD700,       /* vi·ªÅn v√†ng */
       1px -1px 0 #FFD700,
      -1px  1px 0 #FFD700,
       1px  1px 0 #FFD700,
       0px  0px 4px #FFD700; }
.top-item-unit{font-size: 13px; font-weight:800; color:#000000;}
.top-item-score{margin-top:6px; font-weight:800; font-size:13px; color:#111827;}
.top-item-score strong{font-weight:800;margin-right:2px;}
.top-item-meta{
  color:#6b7280;
  font-weight:400;
}
/* Tables */
.table-card{
  margin-top:22px;
  background:#fff;
  border-radius:20px;
  box-shadow:0 16px 35px rgba(15,23,42,.08);
  border:1px solid var(--border);
  overflow:hidden;
}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead{background:#fdf7ef;}
th,td{ padding:8px 10px; text-align:left; white-space:nowrap;}
th{ font-weight:600; color:#4b5563; border-bottom:1px solid var(--border);}
td:nth-child(1){width:40px;text-align:center;color:#6b7280;}
td:nth-child(2){font-weight:600;}
tbody tr{border-top:1px solid var(--border);}
tbody tr:nth-child(odd){background:#fffdfa;}
tbody tr:hover{background:#fef6eb;}

/* View / range toggles */
.view-section{display:none;}
.view-section.active{display:block;}
.range-section{display:none;}
.range-section.active{display:block;}

/* ===== Modal tra c·ª©u k·∫øt qu·∫£ ===== */
.rs-modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  backdrop-filter:blur(3px);
  z-index:70;
  opacity:0;
  pointer-events:none;
  transition:opacity .2s;
}
.rs-modal{
  position:fixed;
  inset:0;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:40px 12px;
  z-index:80;
  pointer-events:none;
}
.rs-modal-inner{
  max-width:1080px;
  width:100%;
  background:#fffdf8;
  border-radius:20px;
  border:1px solid #fcd34d;
  box-shadow:0 14px 40px rgba(0,0,0,.18);
  padding:18px 18px 20px;
  transform:translateY(16px);
  opacity:0;
  transition:opacity .18s, transform .18s;
}
.rs-modal-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:4px;}
.rs-modal-head h2{ margin:0; font-size:20px; font-weight:800; color:#7f1d1d;}
.rs-close{ border:none; background:transparent; font-size:22px; cursor:pointer; color:#6b7280;}
.rs-close:hover{ color:#b91c1c; }
.rs-desc{ margin:0 0 12px; font-size:14px; color:#6b7280;}

/* Form trong modal (t√°i d√πng class c≈©) */
.results-form{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:10px;}
.results-form .field{ flex:1 1 190px; min-width:170px;}
.results-form .field-button{ flex:0 0 auto;}
.results-form label{  display:block; font-size:13px; font-weight:600; color:#4b5563; margin-bottom:4px;}
.results-form input,
.results-form select{
  width:100%;
  padding:9px 14px;
  border-radius:999px;
  border:1px solid #e5e7eb;
  background:#fff;
  font-size:14px;
  outline:none;
  box-shadow:0 1px 2px rgba(0,0,0,.02);
}
.results-form input:focus,
.results-form select:focus{ border-color:#f59e0b; box-shadow:0 0 0 3px rgba(245,158,11,.25);}
.results-summary{ font-size:14px; color:#374151; margin-bottom:6px;}
.results-summary strong{ color:#b91c1c; }
.results-table-wrap{ max-height:420px; overflow:auto; border-radius:14px;}

/* Tr·∫°ng th√°i m·ªü modal */
body.rs-open{ overflow:hidden;}
body.rs-open #rsModal{ pointer-events:auto;}
body.rs-open #rsModalBackdrop{ opacity:1; pointer-events:auto;}
body.rs-open #rsModal .rs-modal-inner{ opacity:1; transform:translateY(0);}

/* ‚úÖ T·ªëi ∆∞u b·∫£ng tr√™n mobile */
@media (max-width:768px){
  .shell{ padding:8px 10px 28px; }
  .hero{ grid-template-columns:1fr; padding:6px 0 0; gap:8px; align-items:flex-start;}
  .hero-title{ font-size:22px; line-height:1.1; margin:0 0 4px; }
  .hero-sub{ font-size:12px; margin:0 0 2px; }
  .hero-controls,
  .hero-tools{ margin-top:4px; gap:6px; }
  .hero-medal{ display:none; }

  /* üî• K√âO KH·ªêI X·∫æP H·∫†NG L√äN G·∫¶N N√öT TRA C·ª®U K·∫æT QU·∫¢ */
  .view-section{ margin-top:0 !important; }
  #view-personal,
  #view-unit{ margin-top:-330px !important; }
  .section-title{ margin-top:0; font-size:13px; }
  .sub-tabs{ margin-top:6px; }
  table{ font-size:12px; }
  th,td{ padding:6px 6px; font-size:12px;}

  /* TOP 3 ‚Äì 3 huy ch∆∞∆°ng n·∫±m tr√™n 1 h√†ng, v√†ng cao h∆°n */
  .top3-card{
    margin-top:2px;
    background:transparent;
    border-radius:0;
    box-shadow:none;
    padding:6px 0 2px;
    display:grid;
    grid-template-columns:repeat(3, minmax(0,1fr));
    gap:6px;
    align-items:flex-end;
    max-width:100%;
  }
  .top-item{ min-width:0; font-size:12px; }
  .top-item--first{ transform:translateY(-10px); }
  .top-item--second,
  .top-item--third{ transform:translateY(4px); }
  .top-medal-img{ width:72px; height:auto; margin:0 auto 4px; }
  .top-item-name{ font-size:12px; }
  .top-item-unit{ font-size:11px; }
  .top-item-score{ font-size:11px; }

  #tbody-personal-week tr td,
  #tbody-personal-month tr td{padding:5px 6px;}
  #tbody-unit-week td,
  #tbody-unit-month td{ padding:5px 6px;}

  .rs-modal{ align-items:stretch; padding:20px 8px; }
  .rs-modal-inner{ padding: 14px 12px !important; border-radius: 14px !important; }
  /* Ti√™u ƒë·ªÅ */
  .rs-modal-head h2{ font-size: 18px !important; margin-bottom: 4px !important; }
  /* M√¥ t·∫£ */
  .rs-desc{ font-size: 13px !important; margin-bottom: 8px !important; line-height: 1.35; }
  /* Form */
  .results-form{ gap: 8px !important; margin-bottom: 8px !important; }
  .results-form label{ font-size: 12px !important; margin-bottom: 2px !important; }
  /* Input + Select */
  .results-form input,
  .results-form select{ padding: 8px 12px !important; font-size: 13px !important; height: 40px !important; }
  /* Kho·∫£ng c√°ch gi·ªØa t·ª´ng nh√≥m input */
  .field{ margin-bottom: 4px !important; }
  /* N√∫t XEM K·∫æT QU·∫¢ */
  .results-form .btn{ padding: 10px 14px !important; font-size: 14px !important; height: 42px !important; }
  .results-form .field-button{ margin-top: 6px !important; }
  /* Kho·∫£ng c√°ch b·∫£ng k·∫øt qu·∫£ */
  .results-summary{ margin: 8px 0 6px !important; font-size: 13px !important; }
  #rsTableWrap table{ font-size: 12px !important; }
  #rsTableWrap th,
  #rsTableWrap td{ padding: 6px !important; }


  }

</style>

<script>
// URL Apps Script ‚Äì d√πng chung v·ªõi Hoctap.html
window.PTKV3_API = 'https://script.google.com/macros/s/AKfycbyaIok3ejGAODhEtIslN1DRdTa3maVYQ7ZzuhR-uIw-MRlpJsIhp0m0bBFP1dyP4eNLpQ/exec';
</script>
</head>
<body>

<!-- ===== HEADER (copy t·ª´ Hoctap) ===== -->
<header class="header">
  <nav class="nav" role="navigation" aria-label="ƒêi·ªÅu h∆∞·ªõng ch√≠nh">
    <a class="brand" href="index.html">BAN CH·ªà HUY PTKV3</a>
    <a href="index.html">Trang ch·ªß</a>
    <a href="tintuc24.html">Tin t·ª©c</a>
    <a href="Hoctap.html">H·ªçc t·∫≠p</a>
    <a href="kiemtra.html">Ki·ªÉm tra</a>
    <a href="xephang.html" aria-current="page" >K·∫øt qu·∫£ ki·ªÉm tra</a>
    <div class="sp"></div>
    <button class="m-toggle" aria-label="M·ªü menu">‚ò∞</button>
  </nav>
</header>

<!-- ===== MOBILE DRAWER (copy t·ª´ Hoctap) ===== -->
<aside id="mDrawer" class="m-drawer" aria-hidden="true" role="dialog" aria-label="Menu">
  <div class="m-head">
    <a class="m-home" href="index.html" aria-label="Trang ch·ªß" title="Trang ch·ªß">üè†</a>
    <span class="m-brand">BAN CH·ªà HUY PTKV3</span>
    <button class="m-close" aria-label="ƒê√≥ng menu">‚úï</button>
  </div>

  <nav class="m-menu" role="navigation" aria-label="Menu di ƒë·ªông">
    <a class="m-item" href="index.html">Trang ch·ªß</a>
    <a class="m-item" href="tintuc24.html">Tin t·ª©c</a>
    <a class="m-item" href="Hoctap.html">H·ªçc t·∫≠p</a>
    <a class="m-item" href="kiemtra.html">Ki·ªÉm tra</a>
    <a class="m-item" href="xephang.html" aria-current="page">K·∫øt qu·∫£ ki·ªÉm tra</a>
  </nav>
</aside>
<div class="m-backdrop" hidden></div>

<!-- ===== MAIN LEADERBOARD ===== -->
<div class="page">
  <div class="shell">

    <section class="hero">
      <div>
        <h1 class="hero-title">
          B·∫¢NG X·∫æP H·∫†NG<br>
          HU·∫§N LUY·ªÜN CH√çNH TR·ªä
        </h1>
        <p class="hero-sub">Vinh danh t·∫≠p th·ªÉ v√† c√° nh√¢n xu·∫•t s·∫Øc</p>

        <div class="hero-controls">
          <div class="view-toggle">
            <button class="pill-lg active" data-view-btn="personal">C√° nh√¢n</button>
            <button class="pill-lg" data-view-btn="unit">T·∫≠p th·ªÉ</button>
          </div>
          <button type="button" class="btn-ghost hero-search-btn" id="openRsModal">
            üîç Tra c·ª©u k·∫øt qu·∫£
          </button>
        </div>
        <p class="status" id="lbStatus"></p>
      </div>

      <div class="hero-medal">
        <img src="./image/bieutuong.png" alt="Huy ch∆∞∆°ng danh hi·ªáu" class="hero-medal-img">
      </div>
    </section>

    <!-- ===== VIEW: C√Å NH√ÇN ===== -->
    <section class="view-section active" id="view-personal">
      <div class="section-title">X·∫øp h·∫°ng c√° nh√¢n</div>
      <div class="sub-tabs">
        <button class="pill-sm active" data-range-btn="personal-week">Tu·∫ßn n√†y</button>
        <button class="pill-sm" data-range-btn="personal-month">Th√°ng n√†y</button>
      </div>

      <!-- C√° nh√¢n ‚Äì Tu·∫ßn n√†y -->
      <div class="range-section active" id="range-personal-week">
        <section class="top3-card" id="top3-personal-week"></section>

        <section class="table-card" aria-label="B·∫£ng x·∫øp h·∫°ng c√° nh√¢n tu·∫ßn n√†y">
          <table>
            <thead>
              <tr>
                <th>TT</th>
                <th>H·ªç v√† T√™n</th>
                <th>ƒê∆°n v·ªã</th>
                <th>ƒêi·ªÉm</th>
                <th>Th·ªùi gian l√†m b√†i</th>
              </tr>
            </thead>
            <tbody id="tbody-personal-week"></tbody>
          </table>
        </section>
      </div>

      <!-- C√° nh√¢n ‚Äì Th√°ng n√†y -->
      <div class="range-section" id="range-personal-month">
        <section class="top3-card" id="top3-personal-month"></section>

        <section class="table-card" aria-label="B·∫£ng x·∫øp h·∫°ng c√° nh√¢n th√°ng n√†y">
          <table>
            <thead>
              <tr>
                <th>TT</th>
                <th>H·ªç v√† T√™n</th>
                <th>ƒê∆°n v·ªã</th>
                <th>ƒêi·ªÉm</th>
                <th>Th·ªùi gian l√†m b√†i</th>
              </tr>
            </thead>
            <tbody id="tbody-personal-month"></tbody>
          </table>
        </section>
      </div>
    </section>

    <!-- ===== VIEW: T·∫¨P TH·ªÇ ===== -->
    <section class="view-section" id="view-unit">
      <div class="section-title">X·∫øp h·∫°ng t·∫≠p th·ªÉ</div>
      <div class="sub-tabs">
        <button class="pill-sm active" data-range-btn="unit-week">Tu·∫ßn n√†y</button>
        <button class="pill-sm" data-range-btn="unit-month">Th√°ng n√†y</button>
      </div>

      <!-- T·∫≠p th·ªÉ ‚Äì Tu·∫ßn n√†y -->
      <div class="range-section active" id="range-unit-week">
        <section class="table-card" aria-label="B·∫£ng x·∫øp h·∫°ng t·∫≠p th·ªÉ tu·∫ßn n√†y">
          <table>
            <thead>
              <tr>
                <th>TT</th>
                <th>ƒê∆°n v·ªã</th>
                <th>ƒêi·ªÉm trung b√¨nh</th>
                <th>S·ªë l∆∞·ª£t thi</th>
                <th>T·ªâ l·ªá ho√†n th√†nh</th>
              </tr>
            </thead>
            <tbody id="tbody-unit-week"></tbody>
          </table>
        </section>
      </div>

      <!-- T·∫≠p th·ªÉ ‚Äì Th√°ng n√†y -->
      <div class="range-section" id="range-unit-month">
        <section class="table-card" aria-label="B·∫£ng x·∫øp h·∫°ng t·∫≠p th·ªÉ th√°ng n√†y">
          <table>
            <thead>
              <tr>
                <th>TT</th>
                <th>ƒê∆°n v·ªã</th>
                <th>ƒêi·ªÉm trung b√¨nh</th>
                <th>S·ªë l∆∞·ª£t thi</th>
                <th>T·ªâ l·ªá ho√†n th√†nh</th>
              </tr>
            </thead>
            <tbody id="tbody-unit-month"></tbody>
          </table>
        </section>
      </div>
    </section>

  </div>
</div>

<!-- ===== MODAL TRA C·ª®U K·∫æT QU·∫¢ ===== -->
<div id="rsModalBackdrop" class="rs-modal-backdrop"></div>
<div id="rsModal" class="rs-modal" aria-hidden="true">
  <div class="rs-modal-inner">
    <div class="rs-modal-head">
      <h2>Tra c·ª©u k·∫øt qu·∫£ ki·ªÉm tra</h2>
      <button type="button" class="rs-close" id="rsCloseBtn">‚úï</button>
    </div>

    <p class="rs-desc">
      Ch·ªçn <strong>k·ª≥ ki·ªÉm tra</strong> v√† nh·∫≠p <strong>c√° nh√¢n</strong> ho·∫∑c <strong>ƒë∆°n v·ªã</strong> ƒë·ªÉ xem
      <strong>k·∫øt qu·∫£</strong>.
    </p>

    <div class="results-form">
      <div class="field">
        <label for="rsExamSelect">K·ª≥ ki·ªÉm tra / K·ª≥ thi</label>
        <select id="rsExamSelect">
          <option value="">‚Äî Ch·ªçn k·ª≥ ki·ªÉm tra ‚Äî</option>
        </select>
      </div>

      <div class="field">
        <label for="rsUser">C√° nh√¢n (H·ªç v√† T√™n)</label>
        <input id="rsUser" type="text" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
      </div>

      <div class="field">
        <label for="rsUnit">ƒê∆°n v·ªã (Ph√≤ng)</label>
        <input id="rsUnit" type="text" placeholder="V√≠ d·ª•: Ph√≤ng Ch√≠nh tr·ªã">
      </div>

      <div class="field field-button">
        <button type="button" class="btn" id="rsSearchBtn">Xem k·∫øt qu·∫£</button>
      </div>
    </div>

    <div id="rsSummary" class="results-summary"></div>

    <div id="rsTableWrap" class="results-table-wrap" hidden>
      <table>
        <thead>
          <tr>
            <th>TT</th>
            <th>H·ªç v√† T√™n</th>
            <th>ƒê∆°n v·ªã</th>
            <th>ƒêi·ªÉm TB</th>
            <th>T·ªïng l∆∞·ª£t thi</th>
          </tr>
        </thead>
        <tbody id="rsTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== FOOTER ===== -->
<footer class="footer">
  <div class="wrap">
    <strong>PTKV3 ‚Ä¢ Trung t√¢m Gi√°o d·ª•c Ch√≠nh tr·ªã s·ªë ¬© 2025</strong>
  </div>
</footer>

<script>
/* ===== Helper g·ªçi API Apps Script ===== */
async function apiCall(action, params = {}) {
  if (!window.PTKV3_API) throw new Error('PTKV3_API ch∆∞a c·∫•u h√¨nh');
  const u = new URL(window.PTKV3_API);
  u.searchParams.set('action', action);
  Object.entries(params).forEach(([k, v]) => {
    if (v !== undefined && v !== null && v !== '') {
      u.searchParams.set(k, v);
    }
  });
  const res = await fetch(u.toString());
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || 'API error');
  return data;
}

function fmtTime(sec){
  sec = Number(sec || 0);
  if (sec <= 0) return '--';
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${m}'${String(s).padStart(2,'0')}"`;
}

function renderPersonal(items, topId, tbodyId){
  const topBox = document.getElementById(topId);
  const tbody  = document.getElementById(tbodyId);
  if (!topBox || !tbody) return;

  // ch·ªâ l·∫•y 10 ng∆∞·ªùi cao nh·∫•t
  const list = (items || []).slice().sort((a,b)=>a.rank-b.rank).slice(0, 10);

  // ===== helper l·∫•y ƒëi·ªÉm & % t·ª´ item =====
  const getScoreInfo = (it)=>{
    // ∆∞u ti√™n score10 n·∫øu c√≥
    let score10 = (it.score10 != null) ? Number(it.score10) : null;

    // percent c√≥ th·ªÉ n·∫±m ·ªü nhi·ªÅu field kh√°c nhau
    let pct = null;
    if (it.percentAvg != null) pct = Number(it.percentAvg);
    else if (it.percent != null) pct = Number(it.percent);
    else if (it.pct != null) pct = Number(it.pct);

    // n·∫øu ch∆∞a c√≥ score10 nh∆∞ng c√≥ pct -> quy v·ªÅ thang 10
    if (score10 == null && pct != null){
      score10 = pct / 10;
    }

    // n·∫øu ch∆∞a c√≥ pct nh∆∞ng c√≥ score10 -> ng∆∞·ª£c l·∫°i
    if (pct == null && score10 != null){
      pct = score10 * 10;
    }

    score10 = Number(score10 || 0);
    pct     = Number(pct || 0);

    return {
      pct,
      score10,
      score10Label: score10.toFixed(1).replace('.0','')
    };
  };

  // ===== Top 3 =====
  topBox.innerHTML = '';
  const m1 = list[0], m2 = list[1], m3 = list[2];
  if (!m1 && !m2 && !m3){
    topBox.innerHTML = '<div style="text-align:center;color:#6b7280;">Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng.</div>';
  } else {
    const makeItem = (cls, medalImg, m) => {
      if (!m) return `
        <article class="top-item ${cls}" style="opacity:.35">
          <img src="${medalImg}" class="top-medal-img" alt="">
          <div class="top-item-name">‚Äî</div>
          <div class="top-item-unit"></div>
          <div class="top-item-score"><strong>--</strong> ƒêi·ªÉm</div>
        </article>`;

      const name  = m.fullName || m.userName || '';
      const unit  = m.unit || m.userUnit || '';
      const { pct, score10Label } = getScoreInfo(m);      // v·∫´n gi·ªØ pct n·∫øu ch·ªó kh√°c c·∫ßn
      const spent = fmtTime(m.durationSec ?? m.spentSec);

      // Top card: ch·ªâ hi·ªÉn th·ªã ƒëi·ªÉm & th·ªùi gian
      return `
        <article class="top-item ${cls}">
          <img src="${medalImg}" alt="" class="top-medal-img">
          <div class="top-item-name">${name}</div>
          <div class="top-item-unit">${unit}</div>
          <div class="top-item-score">
            <strong>${score10Label}</strong> ƒëi·ªÉm
            <span class="top-item-meta"> ‚Ä¢ ${spent}</span>
          </div>
        </article>`;
      };


    topBox.innerHTML =
      makeItem('top-item--second', './image/HCB.png', m2 || null) +
      makeItem('top-item--first',  './image/HCV.png', m1 || null) +
      makeItem('top-item--third',  './image/HCƒê.png', m3 || null);
  }

  // ===== B·∫£ng x·∫øp h·∫°ng t·ª´ h·∫°ng 4‚Äì10 =====
  const rows = list.slice(3).map(it => {
    const name = it.fullName || it.userName || '';
    const unit = it.unit || it.userUnit || '';
    const { pct, score10Label } = getScoreInfo(it);
    const spent = fmtTime(it.durationSec ?? it.spentSec);

    return `<tr>
      <td>${it.rank}</td>
      <td>${name}</td>
      <td>${unit}</td>
      <td title="${pct}%">${score10Label}</td>
      <td>${spent}</td>
    </tr>`;
  });

  tbody.innerHTML = rows.length
    ? rows.join('')
    : '<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:14px;">Ch∆∞a c√≥ th√™m ng∆∞·ªùi tham gia.</td></tr>';
}

/* ===== Render t·∫≠p th·ªÉ ===== */
function renderUnit(items, tbodyId){
  const tbody = document.getElementById(tbodyId);
  if (!tbody) return;

  const rows = (items || [])
    .slice()
    .sort((a,b)=>a.rank-b.rank)
    .map(it=>{
      const avgPct   = it.avgPct ?? it.percent ?? 0;            // % ƒë√∫ng TB
      const score10  = (avgPct / 10).toFixed(1).replace('.0','');
      const attempts = it.attemptsTotal ?? it.members ?? it.count ?? 0;   // ‚úÖ s·ªë l∆∞·ª£t thi
      const completion = it.completionPct ?? it.completionRate ?? 0;     // ‚úÖ t·ªâ l·ªá ho√†n th√†nh %

      return `<tr>
        <td>${it.rank}</td>
        <td>${it.unit}</td>
        <td title="${avgPct}%">${score10}</td>
        <td>${attempts}</td>
        <td>${completion}%</td>
      </tr>`;
    });

  tbody.innerHTML = rows.length
    ? rows.join('')
    : '<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:14px;">Ch∆∞a c√≥ d·ªØ li·ªáu t·∫≠p th·ªÉ.</td></tr>';
}

/* ===== Load d·ªØ li·ªáu t·ª´ Apps Script ===== */
async function loadLeaderboard(){
  const statusEl = document.getElementById('lbStatus');
  try{
    statusEl.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu x·∫øp h·∫°ng...';
    // C√° nh√¢n
    const resUser = await apiCall('leaderboard', { scope:'user', limit:100, bestOf:'best' });
    const itemsUser = resUser.items || [];
    renderPersonal(itemsUser, 'top3-personal-week',  'tbody-personal-week');
    renderPersonal(itemsUser, 'top3-personal-month', 'tbody-personal-month');

    // T·∫≠p th·ªÉ
    const resUnit = await apiCall('leaderboard', { scope:'unit', limit:100, bestOf:'best' });
    const itemsUnit = resUnit.items || [];
    renderUnit(itemsUnit, 'tbody-unit-week');
    renderUnit(itemsUnit, 'tbody-unit-month');

    statusEl.textContent = '';
  }catch(e){
    console.error(e);
    statusEl.textContent = 'L·ªói t·∫£i d·ªØ li·ªáu x·∫øp h·∫°ng: ' + (e.message || e);
  }
}

/* ===== Toggle C√° nh√¢n / T·∫≠p th·ªÉ ===== */
document.querySelectorAll("[data-view-btn]").forEach(function(btn){
  btn.addEventListener("click", function(){
    var view = this.getAttribute("data-view-btn");
    document.querySelectorAll("[data-view-btn]").forEach(function(b){
      b.classList.toggle("active", b === btn);
    });
    document.querySelectorAll(".view-section").forEach(function(sec){
      sec.classList.toggle("active", sec.id === "view-" + view);
    });
  });
});

/* ===== Toggle tu·∫ßn / th√°ng trong t·ª´ng nh√≥m ===== */
document.querySelectorAll("[data-range-btn]").forEach(function(btn){
  btn.addEventListener("click", function(){
    var key = this.getAttribute("data-range-btn"); // personal-week
    var group = key.split("-")[0];                 // personal / unit

    document.querySelectorAll('[data-range-btn^="' + group + '-"]').forEach(function(b){
      b.classList.toggle("active", b === btn);
    });
    document.querySelectorAll('[id^="range-' + group + '-"]').forEach(function(sec){
      sec.classList.toggle("active", sec.id === "range-" + key);
    });
  });
});

/* ===== Mobile drawer (gi·ªëng Hoctap) ===== */
(function(){
  const drawer   = document.getElementById('mDrawer');
  const backdrop = document.querySelector('.m-backdrop');
  const openBtn  = document.querySelector('.m-toggle');
  const closeBtn = drawer?.querySelector('.m-close');

  const focusables = 'a,button,[tabindex]:not([tabindex="-1"])';
  let lastFocus = null;

  document.querySelectorAll('.m-sub').forEach(p => p.hidden = true);
  document.querySelectorAll('.m-drop').forEach(b => b.setAttribute('aria-expanded','false'));

  function open(){
    lastFocus = document.activeElement;
    document.body.classList.add('menu-open','no-scroll');
    drawer?.setAttribute('aria-hidden','false');
    if (backdrop) backdrop.hidden = false;
    drawer?.querySelector(focusables)?.focus?.();
  }
  function close(){
    document.body.classList.remove('menu-open','no-scroll');
    drawer?.setAttribute('aria-hidden','true');
    if (backdrop) backdrop.hidden = true;
    lastFocus?.focus?.();
  }

  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });

  drawer?.addEventListener('click', e=>{
    const btn = e.target.closest('.m-drop');
    if(!btn) return;
    const id = btn.getAttribute('aria-controls') || btn.dataset.target?.replace('#','');
    const panel = id ? document.getElementById(id) : null;
    if(!panel) return;
    const expanded = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', String(!expanded));
    panel.hidden = expanded ? true : false;
  });

  drawer?.addEventListener('click', e=>{
    const a = e.target.closest('a');
    if(a) close();
  });
})();

/* ===== Helper API chung cho leaderboard / results ===== */
async function lbApi(params){
  const u = new URL(window.PTKV3_API);
  Object.entries(params || {}).forEach(([k,v])=>{
    if (v !== undefined && v !== null && String(v).trim() !== '') {
      u.searchParams.set(k, String(v));
    }
  });
  const res = await fetch(u.toString());
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || 'API error');
  return data;
}

// Chu·∫©n ho√° t√™n ƒë∆°n v·ªã b√™n client (ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp trong summary)
function normalizeUnitNameClient_(u){
  if (!u) return '';
  let base = String(u).trim()
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[‚Äì‚Äî‚àí]/g,'-')
    .replace(/\s+/g,' ')
    .trim();
  if (base.indexOf('chinh tri') >= 0 || /\bpct\b/.test(base))
    return 'Ph√≤ng Ch√≠nh tr·ªã';
  if (base.indexOf('tham muu') >= 0 || /\bptm\b/.test(base))
    return 'Ph√≤ng Tham m∆∞u';
  if (
    base.indexOf('hc-kt') >= 0 ||
    base.indexOf('hc kt') >= 0 ||
    base.indexOf('hckt')  >= 0 ||
    (base.indexOf('hau can') >= 0 && (base.indexOf('ky thuat') >= 0 || base.indexOf('kt') >= 0))
  )
    return 'Ph√≤ng H·∫≠u c·∫ßn - K·ªπ thu·∫≠t';
  return String(u).trim();
}

/* ===== Modal tra c·ª©u k·∫øt qu·∫£ ===== */
function initResultsModal(){
  const btnOpen   = document.getElementById('openRsModal');
  const modal     = document.getElementById('rsModal');
  const backdrop  = document.getElementById('rsModalBackdrop');
  const btnClose  = document.getElementById('rsCloseBtn');

  if (!btnOpen || !modal) return;

  const selExam   = document.getElementById('rsExamSelect');
  const inpUser   = document.getElementById('rsUser');
  const inpUnit   = document.getElementById('rsUnit');
  const btnSearch = document.getElementById('rsSearchBtn');
  const summaryEl = document.getElementById('rsSummary');
  const wrapTable = document.getElementById('rsTableWrap');
  const tbody     = document.getElementById('rsTableBody');
  const rsThead  = rsTableWrap.querySelector('thead');

  function openModal(){
    document.body.classList.add('rs-open');
    summaryEl.textContent = '';
    wrapTable.hidden = true;
    tbody.innerHTML = '';
  }
  function closeModal(){
    document.body.classList.remove('rs-open');
  }

  btnOpen.addEventListener('click', openModal);
  btnClose.addEventListener('click', closeModal);
  backdrop.addEventListener('click', closeModal);
  document.addEventListener('keydown', e=>{
    if (e.key === 'Escape') closeModal();
  });

  // 1) Load danh s√°ch k·ª≥ ki·ªÉm tra t·ª´ Banks.title
(async ()=>{
  try{
    const data = await apiCall('banks');          // ‚úÖ g·ªçi th·∫≥ng action=banks
    const banks = (data.banks || [])
      .filter(b => !b.disabled)                   // n·∫øu backend c√≥ c·ªù disabled
      .sort((a,b)=>
        String(a.title || a.bankId || '')
          .localeCompare(String(b.title || b.bankId || ''), 'vi')
      );

    banks.forEach(b=>{
      const opt = document.createElement('option');
      opt.value = b.bankId || b.id || b.title || '';   // g·ª≠i bankId cho API results
      opt.textContent = b.title || b.bankId || '';     // ‚úÖ label hi·ªÉn th·ªã t·ª´ c·ªôt title
      selExam.appendChild(opt);
    });
  }catch(err){
    console.error('Load banks failed', err);
  }
})();

  async function runSearch(){
    const bank  = selExam.value.trim();
    const qUser = inpUser.value.trim();
    const qUnit = inpUnit.value.trim();
    if (!bank){
      summaryEl.innerHTML = '<span style="color:#b91c1c;">Vui l√≤ng ch·ªçn k·ª≥ ki·ªÉm tra tr∆∞·ªõc.</span>';
      wrapTable.hidden = true;
      tbody.innerHTML = '';
      return;
    }
    if (!qUser && !qUnit){
      summaryEl.innerHTML = '<span style="color:#b91c1c;">Nh·∫≠p <b>c√° nh√¢n</b> ho·∫∑c <b>ƒë∆°n v·ªã</b> ƒë·ªÉ tra c·ª©u.</span>';
      wrapTable.hidden = true;
      tbody.innerHTML = '';
      return;
    }
    summaryEl.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu...';
    wrapTable.hidden = true;
    tbody.innerHTML = '';
    try{
      const data = await lbApi({
        action: 'results',
        bank:   bank,
        user:   qUser,
        unit:   qUnit
      });
            const items = data.itemsUser || [];
      if (!items.length){
        summaryEl.textContent = 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán tra c·ª©u.';
        wrapTable.hidden = true;
        return;
      }

      // Helper l·∫•y ƒëi·ªÉm t·ª´ item
      const getScoreInfo = (it)=>{
        let score10 = (it.score10 != null) ? Number(it.score10) : null;
        let pct     = null;
        if (it.percentAvg != null) pct = Number(it.percentAvg);
        else if (it.percent != null) pct = Number(it.percent);

        if (score10 == null && pct != null){
          score10 = pct / 10;
        }
        if (pct == null && score10 != null){
          pct = score10 * 10;
        }
        score10 = Number(score10 || 0);
        pct     = Number(pct || 0);
        return {
          pct,
          score10,
          score10Label: score10.toFixed(1).replace('.0','')
        };
      };

      // ===== Ph·∫ßn summary =====
      let headerText = '';
      if (qUnit){
        // Tra theo ph√≤ng
        const unitNorm = normalizeUnitNameClient_(qUnit);
        let sumScore10 = 0;
        let totalAttempts = 0;
        items.forEach(it=>{
          const { score10 } = getScoreInfo(it);
          sumScore10    += score10;
          totalAttempts += Number(it.attemptsTotal || 0);
        });
        const avgScore = items.length ? (sumScore10 / items.length) : 0;
        const avgStr   = avgScore.toFixed(1).replace('.0','');
        headerText = `ƒê∆°n v·ªã <strong>${unitNorm}</strong> ‚Äì ${items.length} c√°n b·ªô, <strong>${totalAttempts}</strong> l∆∞·ª£t thi, ƒëi·ªÉm trung b√¨nh <strong>${avgStr}</strong>.`;
      }else{
        // Tra theo 1 c√° nh√¢n
        const it = items[0];
        const { pct, score10Label } = getScoreInfo(it);
        headerText = `C√° nh√¢n <strong>${it.userName}</strong> ‚Äì ${it.userUnit}, ƒëi·ªÉm trung b√¨nh <strong>${score10Label}</strong> (${pct}%), t·ªïng <strong>${it.attemptsTotal}</strong> l∆∞·ª£t thi.`;
      }
      summaryEl.innerHTML = headerText;

      // ===== Render b·∫£ng =====
      if (qUnit){
        // üîπ Tra theo ƒë∆°n v·ªã ‚Üí kh√¥ng c·∫ßn c·ªôt ƒê∆°n v·ªã
        rsThead.innerHTML = `
          <tr>
            <th>TT</th>
            <th>H·ªç v√† T√™n</th>
            <th>ƒêi·ªÉm TB</th>
            <th>T·ªïng l∆∞·ª£t thi</th>
          </tr>`;
        const rows = items.map((it, idx)=>{
          const { score10Label } = getScoreInfo(it);
          const total = Number(it.attemptsTotal || 0);
          return `<tr>
            <td>${idx+1}</td>
            <td>${it.userName}</td>
            <td>${score10Label}</td>
            <td>${total}</td>
          </tr>`;
        });
        tbody.innerHTML = rows.join('');
      }else{
        // üîπ Tra theo c√° nh√¢n ‚Üí hi·ªÉn th·ªã c·∫£ ƒê∆°n v·ªã
        rsThead.innerHTML = `
          <tr>
            <th>TT</th>
            <th>H·ªç v√† T√™n</th>
            <th>ƒê∆°n v·ªã</th>
            <th>ƒêi·ªÉm TB</th>
            <th>T·ªïng l∆∞·ª£t thi</th>
          </tr>`;
        const rows = items.map((it, idx)=>{
          const { score10Label } = getScoreInfo(it);
          const total = Number(it.attemptsTotal || 0);
          return `<tr>
            <td>${idx+1}</td>
            <td>${it.userName}</td>
            <td>${it.userUnit}</td>
            <td>${score10Label}</td>
            <td>${total}</td>
          </tr>`;
        });
        tbody.innerHTML = rows.join('');
      }
      wrapTable.hidden = false;
    }catch(err){
      console.error(err);
      summaryEl.innerHTML = '<span style="color:#b91c1c;">L·ªói t·∫£i d·ªØ li·ªáu: '+ (err.message || err) +'</span>';
      wrapTable.hidden = true;
      tbody.innerHTML = '';
    }
  }

  btnSearch.addEventListener('click', runSearch);
  [selExam, inpUser, inpUnit].forEach(el=>{
    el.addEventListener('keydown', e=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        runSearch();
      }
    });
  });
}

/* ===== Kh·ªüi ƒë·ªông sau khi load xong ===== */
document.addEventListener('DOMContentLoaded', function(){
  loadLeaderboard();
  initResultsModal();
});
</script>
</body>
</html>
